import{b as Le,r as n,j as t,c as xe}from"./app-so_3s6IB.js";import{M as Te,b as Ue}from"./monitor-layout-BRXoWMc2.js";import{g as $e}from"./device-icons-CZzWEOUv.js";import{c as R}from"./createLucideIcon-yWkQp2xk.js";import{P as he,S as te,T as se}from"./trash-2-iz0rtbjU.js";import{L as pe}from"./layers-BZ_p3hws.js";import{S as ge}from"./server-BmtO3NRX.js";import{R as Re}from"./rotate-ccw-BBJrl77u.js";import{X as Ie}from"./x-D9l108OW.js";import{S as Ae}from"./save-CRnqec2H.js";import"./app-C4xCnywQ.js";import"./activity-C72jcQKz.js";import"./wifi-C4Swf5D_.js";/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oe=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],Xe=R("ArrowLeft",Oe);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]],ae=R("Image",Ye);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]],fe=R("Upload",Be);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ze=[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"11",x2:"11",y1:"8",y2:"14",key:"1vmskp"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]],We=R("ZoomIn",Ze);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const He=[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]],Je=R("ZoomOut",He);function dt(){const{currentBranch:_}=Le().props,S=n.useMemo(()=>new URLSearchParams(window.location.search),[]),j=n.useMemo(()=>{const e=S.get("location_id");return e?Number(e):null},[S]),I=n.useMemo(()=>{const e=S.get("floor_id");return e?Number(e):null},[S]),A=n.useMemo(()=>{const e=S.get("deviceId");return e?Number(e):null},[S]),x=n.useMemo(()=>S.get("mode")==="config",[S]),[P,z]=n.useState([]),[d,F]=n.useState(null),[C,N]=n.useState([]),[O,le]=n.useState([]),[w,Z]=n.useState(""),[re,X]=n.useState(!1),[h,y]=n.useState({name:""}),[p,E]=n.useState(null),[be,L]=n.useState(!1),[W,Y]=n.useState(null),[ve,ne]=n.useState([]),[g,T]=n.useState(null),f=n.useRef(null),[U,H]=n.useState(1),[M,J]=n.useState(0),[D,Q]=n.useState(0),[V,$]=n.useState(!1),[oe,ie]=n.useState(!1),b=n.useRef(null),ke=n.useRef(null),v=n.useRef(null),c=n.useRef(null),m=n.useMemo(()=>P.find(e=>e.id===d)||null,[P,d]),q=n.useMemo(()=>m?m.location_id?O.filter(e=>e.location_id===m.location_id):O.filter(e=>!e.location_id):[],[O,m]);n.useEffect(()=>{w&&typeof w=="number"&&(q.some(s=>s.id===w)||Z(""))},[q,w]),n.useEffect(()=>{const e=_?.id?String(_.id):null,s=e==="all"?"/api/locations":e?`/api/locations?branch_id=${e}`:"/api/locations";fetch(s,{credentials:"same-origin",headers:{Accept:"application/json"}}).then(a=>a.ok?a.json():[]).then(ne).catch(()=>ne([]))},[_?.id]),n.useEffect(()=>{const e=new URLSearchParams,s=_?.id?String(_.id):null;s&&s!=="all"&&e.set("branch_id",s),j&&e.set("location_id",String(j));const a=e.toString()?`/api/floors?${e.toString()}`:"/api/floors";console.log("Fetching floors from:",a),fetch(a).then(r=>r.json()).then(r=>{console.log("Floors loaded:",r.length,r),z(r),I&&r.some(o=>o.id===I)?F(I):r.length>0?F(r[0].id):F(null)}).catch(r=>{console.error("Error loading floors:",r),z([])});const l=new URLSearchParams;l.set("per_page","1000"),s&&s!=="all"&&l.set("branch_id",s);const i=l.toString()?`/api/devices?${l.toString()}`:"/api/devices?per_page=1000";fetch(i).then(r=>r.json()).then(r=>{const o=r?.data||[];le(o),A&&o.some(u=>u.id===A)&&Z(A)}).catch(()=>le([]))},[_?.id,j,I,A]),n.useEffect(()=>{d&&fetch(`/api/device-positions?floor_id=${d}`).then(e=>e.json()).then(N).catch(()=>N([]))},[d]),n.useEffect(()=>()=>{c.current!==null&&(cancelAnimationFrame(c.current),c.current=null)},[]);const de=async e=>{try{const s=await fetch("/api/device-positions/upsert",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"same-origin",body:JSON.stringify(e)});if(!s.ok){const l=await s.text().catch(()=>"");console.error("Save position failed:",s.status,l),alert(`Failed to save position (${s.status}).`);return}const a=await s.json();N(l=>{const i=l.findIndex(r=>r.device_id===a.device_id&&r.floor_id===a.floor_id);if(i>=0){const r=l.slice();return r[i]=a,r}return[...l,a]}),d&&fetch(`/api/device-positions?floor_id=${d}`).then(l=>l.json()).then(N).catch(()=>N([]))}catch(s){console.error("Save position error:",s),alert("Network error while saving position")}},je=async()=>{if(h.name.trim()){X(!0);try{const e=_?.id?String(_.id):null,s=await fetch("/api/floors",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({branch_id:e&&e!=="all"?typeof e=="string"?parseInt(e):e:null,location_id:j||null,name:h.name.trim(),level:h.level??null,plan_image_path:h.plan_image_path||null})});if(s.ok){const a=await s.json();z(l=>[...l,a].sort((i,r)=>(i.level??0)-(r.level??0))),F(a.id),y({name:""}),L(!1)}else{const a=await s.json().catch(()=>({message:"Failed to create floor"}));alert(a.message||"Failed to create floor")}}catch(e){console.error("Error creating floor:",e),alert("Network error while creating floor")}finally{X(!1)}}},Ne=async()=>{if(!(!p||!h.name.trim())){X(!0);try{const e=await fetch(`/api/floors/${p.id}`,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({branch_id:p.branch_id,location_id:p.location_id,name:h.name.trim(),level:h.level??null,plan_image_path:h.plan_image_path||null})});if(e.ok){const s=await e.json();z(a=>a.map(l=>l.id===s.id?s:l).sort((l,i)=>(l.level??0)-(i.level??0))),E(null),y({name:""}),L(!1),d===s.id&&(F(null),setTimeout(()=>F(s.id),0))}else{const s=await e.json().catch(()=>({message:"Failed to update floor"})),a=s.message||s.error||"Failed to update floor";alert(a)}}catch(e){console.error("Error updating floor:",e),alert("Network error while updating floor")}finally{X(!1)}}},we=async e=>{try{const s=await fetch(`/api/floors/${e}`,{method:"DELETE",headers:{Accept:"application/json"},credentials:"same-origin"});if(s.ok||s.status===204)z(a=>a.filter(l=>l.id!==e)),d===e&&F(null),Y(null);else{const a=await s.text().catch(()=>"Failed to delete floor");alert(`Failed to delete floor: ${a}`)}}catch(s){console.error("Error deleting floor:",s),alert("Network error while deleting floor")}},ce=e=>{E({...e}),y({name:e.name,level:e.level??null,plan_image_path:e.plan_image_path??""}),L(!0)},me=()=>{E(null),y({name:"",level:null,plan_image_path:""}),L(!0)},G=()=>{L(!1),E(null),y({name:""})},ye=async e=>{if(!x||!d||!w||typeof w!="number")return;const s=e.target;if(s.tagName==="BUTTON"||s.closest("button")||s.closest("[data-device-marker]")||!v.current)return;e.preventDefault(),e.stopPropagation();const a=v.current.getBoundingClientRect(),l=U,i=a.width*(1-l)/2-M,r=a.height*(1-l)/2-D;let o=(e.clientX-a.left-i)/(a.width*l),u=(e.clientY-a.top-r)/(a.height*l);o=Math.min(1,Math.max(0,o)),u=Math.min(1,Math.max(0,u)),await de({floor_id:d,device_id:w,x:o,y:u})},_e=e=>({left:`${e.x*100}%`,top:`${e.y*100}%`,transform:"translate(-50%, -100%)"}),B=e=>O.find(s=>s.id===e)?.name||`#${e}`,Se=()=>{H(e=>Math.min(e+.25,3))},Fe=()=>{H(e=>Math.max(e-.25,.5))},Ce=()=>{H(1),J(0),Q(0)},Pe=e=>{const s=e.target;s.closest("[data-device-marker]")||s.tagName==="BUTTON"||s.closest("button")||g||(e.button===1||e.button===2||e.button===0&&oe)&&(e.preventDefault(),e.stopPropagation(),$(!0),b.current={x:e.clientX-M,y:e.clientY-D})},ue=()=>{$(!1),b.current=null},Me=e=>{const s=e.target;if(!(s.closest("[data-device-marker]")||s.tagName==="BUTTON"||s.closest("button"))&&!g&&e.touches.length===1){e.preventDefault(),e.stopPropagation();const a=e.touches[0];$(!0),b.current={x:a.clientX-M,y:a.clientY-D}}},De=e=>{if(V&&b.current&&e.touches.length===1){e.preventDefault(),e.stopPropagation();const s=e.touches[0];J(s.clientX-b.current.x),Q(s.clientY-b.current.y)}},ze=()=>{$(!1),b.current=null};return n.useEffect(()=>{const e=a=>{a.key===" "&&(a.preventDefault(),ie(!0))},s=a=>{a.key===" "&&(ie(!1),$(!1),b.current=null)};return window.addEventListener("keydown",e),window.addEventListener("keyup",s),()=>{window.removeEventListener("keydown",e),window.removeEventListener("keyup",s)}},[]),t.jsxs(Te,{title:"Floor Plan",children:[t.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[t.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("button",{onClick:()=>{j?xe.visit(`/monitor/maps?location_id=${j}`):xe.visit("/monitor/maps")},className:"inline-flex items-center justify-center gap-2 rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-medium text-slate-700 transition-all hover:bg-slate-50 hover:shadow-sm dark:border-slate-600 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600",title:"Go back to maps",children:[t.jsx(Xe,{className:"size-4"}),t.jsx("span",{className:"hidden sm:inline",children:"Back"})]}),t.jsxs("div",{children:[t.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-slate-900 dark:text-white",children:"Floor Plan Management"}),t.jsx("p",{className:"mt-1 text-sm text-slate-600 dark:text-slate-400",children:x?"Manage floor plans and device positions":"View floor plans and device locations"})]})]}),x&&t.jsxs("button",{onClick:me,className:"inline-flex items-center gap-2 rounded-lg bg-gradient-to-r from-blue-600 to-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-lg transition-all hover:from-blue-700 hover:to-indigo-700 hover:shadow-xl",children:[t.jsx(he,{className:"size-4"}),t.jsx("span",{children:"New Floor"})]})]}),t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-4",children:[t.jsx("div",{className:"lg:col-span-1",children:t.jsxs("div",{className:"rounded-xl border border-slate-200 bg-white shadow-lg dark:border-slate-700 dark:bg-slate-800",children:[t.jsx("div",{className:"border-b border-slate-200 p-4 dark:border-slate-700",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(pe,{className:"size-5 text-blue-600 dark:text-blue-400"}),t.jsx("h2",{className:"text-lg font-semibold text-slate-900 dark:text-white",children:"Floors"}),t.jsx("span",{className:"ml-auto rounded-full bg-slate-100 px-2.5 py-0.5 text-xs font-semibold text-slate-600 dark:bg-slate-700 dark:text-slate-400",children:P.length})]})}),t.jsx("div",{className:"max-h-[400px] overflow-y-auto p-2",children:P.length===0?t.jsxs("div",{className:"p-8 text-center",children:[t.jsx(pe,{className:"mx-auto mb-3 size-10 text-slate-400"}),t.jsx("p",{className:"text-sm text-slate-600 dark:text-slate-400",children:"No floors found"}),x&&t.jsx("button",{onClick:me,className:"mt-3 text-sm text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300",children:"Create your first floor"})]}):t.jsx("div",{className:"space-y-2",children:P.map(e=>t.jsx("div",{className:`group relative rounded-lg border-2 p-3 transition-all cursor-pointer ${d===e.id?"border-blue-500 bg-blue-50 dark:bg-blue-950/20 shadow-md":"border-slate-200 bg-slate-50 hover:border-slate-300 hover:bg-slate-100 dark:border-slate-700 dark:bg-slate-900/50 dark:hover:bg-slate-800"}`,onClick:()=>F(e.id),children:t.jsxs("div",{className:"flex items-start justify-between gap-2",children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[e.level!==null&&t.jsxs("span",{className:"flex-shrink-0 rounded bg-blue-100 px-1.5 py-0.5 text-xs font-bold text-blue-700 dark:bg-blue-900/50 dark:text-blue-300",children:["L",e.level]}),t.jsx("h3",{className:"truncate font-semibold text-slate-900 dark:text-white",children:e.name})]}),e.plan_image_path&&t.jsxs("div",{className:"mt-1 flex items-center gap-1 text-xs text-slate-500 dark:text-slate-400",children:[t.jsx(ae,{className:"size-3"}),t.jsx("span",{className:"truncate",children:"Plan image set"})]}),C.filter(s=>s.floor_id===e.id).length>0&&t.jsxs("div",{className:"mt-1 text-xs text-slate-500 dark:text-slate-400",children:[C.filter(s=>s.floor_id===e.id).length," device",C.filter(s=>s.floor_id===e.id).length!==1?"s":""]})]}),x&&t.jsxs("div",{className:"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[t.jsx("button",{onClick:s=>{s.stopPropagation(),ce(e)},className:"rounded p-1.5 text-blue-600 hover:bg-blue-100 dark:text-blue-400 dark:hover:bg-blue-900/50",title:"Edit floor",children:t.jsx(te,{className:"size-4"})}),t.jsx("button",{onClick:s=>{s.stopPropagation(),Y(e.id)},className:"rounded p-1.5 text-red-600 hover:bg-red-100 dark:text-red-400 dark:hover:bg-red-900/50",title:"Delete floor",children:t.jsx(se,{className:"size-4"})})]})]})},e.id))})})]})}),t.jsxs("div",{className:"lg:col-span-3 space-y-4",children:[x&&d&&t.jsx("div",{className:"rounded-xl border border-slate-200 bg-gradient-to-r from-slate-50 to-slate-100 p-4 dark:border-slate-700 dark:from-slate-900/50 dark:to-slate-800/50",children:t.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(ge,{className:"size-5 text-blue-600 dark:text-blue-400"}),t.jsx("span",{className:"text-sm font-semibold text-slate-700 dark:text-slate-300",children:"Place Device on Floor"})]}),t.jsxs("select",{className:"flex-1 w-full sm:w-auto rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-700 dark:text-white",value:w||"",onChange:e=>Z(e.target.value?Number(e.target.value):""),children:[t.jsx("option",{value:"",children:"â€” Select Device â€”"}),q.map(e=>t.jsxs("option",{value:e.id,children:[e.name," (",e.ip_address,")"]},e.id))]}),w&&t.jsx("p",{className:"text-xs text-slate-600 dark:text-slate-400",children:"Click on the plan to place this device"})]})}),t.jsx("div",{className:"relative",children:t.jsxs("div",{ref:v,onClick:ye,onMouseDown:Pe,onTouchStart:Me,onTouchMove:De,onTouchEnd:ze,onMouseMove:e=>{if(V&&b.current){e.preventDefault(),e.stopPropagation(),J(e.clientX-b.current.x),Q(e.clientY-b.current.y);return}x&&(!g||!d||!v.current||(e.preventDefault(),e.stopPropagation(),c.current!==null&&cancelAnimationFrame(c.current),c.current=requestAnimationFrame(()=>{if(!v.current)return;const s=v.current.getBoundingClientRect(),a=U,l=s.width*(1-a)/2-M,i=s.height*(1-a)/2-D;let r=(e.clientX-s.left-l)/(s.width*a),o=(e.clientY-s.top-i)/(s.height*a);f.current&&(r-=f.current.x,o-=f.current.y),r=Math.min(1,Math.max(0,r)),o=Math.min(1,Math.max(0,o)),N(u=>u.map(k=>k.device_id===g?{...k,x:r,y:o}:k)),c.current=null})))},onMouseUp:async e=>{if(ue(),!x||!g||!d||!v.current)return;const s=e.target;if(s.tagName==="BUTTON"||s.closest("button")){T(null),f.current=null,c.current!==null&&(cancelAnimationFrame(c.current),c.current=null);return}e.preventDefault(),e.stopPropagation(),c.current!==null&&(cancelAnimationFrame(c.current),c.current=null);const a=v.current.getBoundingClientRect(),l=U,i=a.width*(1-l)/2-M,r=a.height*(1-l)/2-D;let o=(e.clientX-a.left-i)/(a.width*l),u=(e.clientY-a.top-r)/(a.height*l);f.current&&(o-=f.current.x,u-=f.current.y),o=Math.min(1,Math.max(0,o)),u=Math.min(1,Math.max(0,u));const k=C.find(K=>K.device_id===g);if(!window.confirm(`Move ${k?B(k.device_id):"device"} to (${(o*100).toFixed(1)}%, ${(u*100).toFixed(1)}%)?`)){k&&N(K=>K.map(ee=>ee.device_id===k.device_id?{...ee,x:k.x,y:k.y}:ee)),T(null),f.current=null;return}const Ee={floor_id:d,device_id:g,x:o,y:u,marker_type:void 0};T(null),f.current=null,await de(Ee)},onMouseLeave:e=>{if(ue(),g&&x){c.current!==null&&(cancelAnimationFrame(c.current),c.current=null);const s=C.find(a=>a.device_id===g);s&&N(a=>a.map(l=>l.device_id===s.device_id?{...l,x:s.x,y:s.y}:l)),T(null),f.current=null}},className:"relative w-full overflow-hidden rounded-xl border border-slate-200 bg-slate-50 dark:border-slate-700 dark:bg-slate-900 touch-pan-y touch-pan-x",style:{aspectRatio:"16 / 10",minHeight:"300px",userSelect:"none",WebkitUserSelect:"none",WebkitTouchCallout:"none",touchAction:"pan-x pan-y",cursor:V?"grabbing":oe?"grab":g?"grabbing":"default"},children:[t.jsxs("div",{className:"absolute right-2 sm:right-4 top-2 sm:top-4 z-20 flex flex-col gap-1 sm:gap-1.5 rounded-lg bg-white/95 backdrop-blur-sm border border-slate-200/50 p-1.5 sm:p-2 shadow-xl dark:bg-slate-800/95 dark:border-slate-700/50",onClick:e=>e.stopPropagation(),children:[t.jsx("button",{onClick:e=>{e.stopPropagation(),Se()},className:"rounded-md border border-slate-300 p-1.5 sm:p-1.5 hover:bg-slate-100 active:scale-95 transition-all dark:border-slate-600 dark:hover:bg-slate-700 touch-manipulation",title:"Zoom In",children:t.jsx(We,{className:"size-4 sm:size-4"})}),t.jsx("button",{onClick:e=>{e.stopPropagation(),Fe()},className:"rounded-md border border-slate-300 p-1.5 sm:p-1.5 hover:bg-slate-100 active:scale-95 transition-all dark:border-slate-600 dark:hover:bg-slate-700 touch-manipulation",title:"Zoom Out",children:t.jsx(Je,{className:"size-4 sm:size-4"})}),t.jsx("button",{onClick:e=>{e.stopPropagation(),Ce()},className:"rounded-md border border-slate-300 p-1.5 sm:p-1.5 hover:bg-slate-100 active:scale-95 transition-all dark:border-slate-600 dark:hover:bg-slate-700 touch-manipulation",title:"Reset Zoom",children:t.jsx(Re,{className:"size-4 sm:size-4"})}),t.jsxs("div",{className:"px-1.5 py-1 text-center text-[10px] font-semibold text-slate-600 dark:text-slate-400 border-t border-slate-200 dark:border-slate-700 mt-0.5",children:[Math.round(U*100),"%"]})]}),t.jsxs("div",{style:{transform:`translate(${M}px, ${D}px) scale(${U})`,transformOrigin:"top left",width:"100%",height:"100%"},children:[m?.plan_image_path?t.jsx("img",{ref:ke,src:m.plan_image_path,className:"h-full w-full object-contain select-none",style:{userSelect:"none",WebkitUserSelect:"none",pointerEvents:"none"},alt:m.name,draggable:!1}):t.jsxs("div",{className:"absolute inset-0 flex items-center justify-center text-slate-500 dark:text-slate-400",children:[t.jsx(fe,{className:"mr-2 size-5"})," Select a floor with a plan image"]}),m&&C.map(e=>t.jsx("div",{"data-device-marker":!0,className:`absolute ${x?"cursor-move group":"cursor-default"}`,style:{..._e(e),userSelect:"none",WebkitUserSelect:"none",pointerEvents:"auto"},title:`${B(e.device_id)} @ (${(e.x*100).toFixed(1)}%, ${(e.y*100).toFixed(1)}%)`,onMouseDown:s=>{if(s.preventDefault(),s.stopPropagation(),x&&v.current){const a=v.current.getBoundingClientRect();s.currentTarget.getBoundingClientRect();const i=s.clientX-a.left,r=s.clientY-a.top,o=e.x*a.width,u=e.y*a.height;f.current={x:(i-o)/a.width,y:(r-u)/a.height},T(e.device_id)}},draggable:!1,children:t.jsxs("div",{className:"relative flex -translate-y-1/2 flex-col items-center select-none",style:{userSelect:"none",WebkitUserSelect:"none"},children:[t.jsx("div",{className:"rounded bg-white/90 px-2 py-0.5 text-[10px] font-medium shadow dark:bg-slate-800/90 select-none",style:{userSelect:"none",WebkitUserSelect:"none"},children:B(e.device_id)}),t.jsx("div",{className:`mt-1 rounded-full p-1.5 shadow ring-2 ring-white/60 dark:ring-slate-900/60 select-none relative animate-pulse ${e.device?.status==="online"?"bg-green-600 text-white":e.device?.status==="warning"?"bg-yellow-500 text-white":"bg-red-600 text-white"}`,style:{userSelect:"none",WebkitUserSelect:"none",boxShadow:e.device?.status==="online"?"0 0 15px rgba(34, 197, 94, 0.8), 0 0 30px rgba(34, 197, 94, 0.5), 0 0 45px rgba(34, 197, 94, 0.3)":e.device?.status==="warning"?"0 0 15px rgba(234, 179, 8, 0.8), 0 0 30px rgba(234, 179, 8, 0.5), 0 0 45px rgba(234, 179, 8, 0.3)":"0 0 15px rgba(220, 38, 38, 0.8), 0 0 30px rgba(220, 38, 38, 0.5), 0 0 45px rgba(220, 38, 38, 0.3)"},children:(()=>{const s=$e(e.device?.category||"");return t.jsx(s,{className:"size-5"})})()}),x&&g!==e.device_id&&t.jsx("button",{onClick:async s=>{if(s.preventDefault(),s.stopPropagation(),!confirm(`Remove ${B(e.device_id)} from this floor?`))return;const a=await fetch(`/api/device-positions/${e.id}`,{method:"DELETE",headers:{Accept:"application/json"},credentials:"same-origin"});if(a.status===204||a.ok)N(l=>l.filter(i=>i.id!==e.id));else{const l=await a.text().catch(()=>"");alert(`Failed to delete position (${a.status}). ${l}`)}},onMouseDown:s=>{s.preventDefault(),s.stopPropagation()},className:"absolute -bottom-6 left-1/2 -translate-x-1/2 hidden rounded bg-red-600 px-1.5 py-0.5 text-[10px] font-semibold text-white shadow hover:bg-red-700 group-hover:block z-10",title:"Delete pin",children:"Delete"})]})},e.device_id))]})]})}),m&&t.jsx("div",{className:"rounded-xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("h3",{className:"text-lg font-semibold text-slate-900 dark:text-white",children:m.name}),t.jsxs("div",{className:"mt-1 flex flex-wrap items-center gap-3 text-sm text-slate-600 dark:text-slate-400",children:[m.level!==null&&t.jsxs("span",{className:"flex items-center gap-1",children:[t.jsx(Ue,{className:"size-4"}),"Level ",m.level]}),t.jsxs("span",{className:"flex items-center gap-1",children:[t.jsx(ge,{className:"size-4"}),C.filter(e=>e.floor_id===m.id).length," device",C.filter(e=>e.floor_id===m.id).length!==1?"s":""]}),m.plan_image_path&&t.jsxs("span",{className:"flex items-center gap-1 text-green-600 dark:text-green-400",children:[t.jsx(ae,{className:"size-4"}),"Plan image loaded"]})]})]}),x&&t.jsx("div",{className:"flex items-center gap-2",children:t.jsxs("button",{onClick:()=>ce(m),className:"inline-flex items-center gap-2 rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-medium text-slate-700 transition-all hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600",children:[t.jsx(te,{className:"size-4"}),t.jsx("span",{className:"hidden sm:inline",children:"Edit"})]})})]})})]})]}),t.jsx("div",{className:"rounded-lg border border-slate-200 bg-slate-50 p-3 dark:border-slate-700 dark:bg-slate-800/50",children:t.jsx("p",{className:"text-xs text-slate-600 dark:text-slate-400",children:x?t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"hidden sm:inline",children:"ðŸ’¡ Tip: Use zoom buttons to zoom. Pan with middle mouse button, right mouse button, or Space + drag. Select a device and click on the plan to place it."}),t.jsx("span",{className:"sm:hidden",children:"ðŸ’¡ Tip: Use zoom buttons to zoom. Touch and drag to pan. Select a device and tap on the plan to place it."})]}):t.jsxs(t.Fragment,{children:[t.jsxs("span",{className:"hidden sm:inline",children:["View-only mode. Add ",t.jsx("code",{className:"rounded bg-slate-200 px-1 py-0.5 text-[10px] dark:bg-slate-700",children:"?mode=config"})," to the URL to enable editing."]}),t.jsx("span",{className:"sm:hidden",children:"View-only mode. Add ?mode=config to enable editing."})]})})})]}),be&&t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4",onClick:G,children:t.jsxs("div",{className:"w-full max-w-2xl rounded-2xl border border-slate-200 bg-white shadow-2xl dark:border-slate-700 dark:bg-slate-800",onClick:e=>e.stopPropagation(),children:[t.jsx("div",{className:"border-b border-slate-200 p-6 dark:border-slate-700",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 p-2",children:p?t.jsx(te,{className:"size-5 text-white"}):t.jsx(he,{className:"size-5 text-white"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-xl font-bold text-slate-900 dark:text-white",children:p?"Edit Floor":"Create New Floor"}),t.jsx("p",{className:"text-sm text-slate-600 dark:text-slate-400",children:p?"Update floor details and plan image":"Add a new floor plan to the system"})]})]}),t.jsx("button",{onClick:G,className:"rounded-lg p-2 text-slate-500 transition-all hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-700",children:t.jsx(Ie,{className:"size-5"})})]})}),t.jsxs("div",{className:"p-6 space-y-4",children:[t.jsxs("div",{children:[t.jsxs("label",{className:"mb-2 block text-sm font-medium text-slate-700 dark:text-slate-300",children:["Floor Name ",t.jsx("span",{className:"text-red-500",children:"*"})]}),t.jsx("input",{type:"text",placeholder:"e.g., Block A - Level 2, Main Building - Ground Floor",className:"w-full rounded-lg border border-slate-300 bg-white px-4 py-2.5 text-slate-900 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white",value:h.name,onChange:e=>y(s=>({...s,name:e.target.value}))})]}),t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"mb-2 block text-sm font-medium text-slate-700 dark:text-slate-300",children:"Level (Optional)"}),t.jsx("input",{type:"number",placeholder:"e.g., 0, 1, 2, -1",className:"w-full rounded-lg border border-slate-300 bg-white px-4 py-2.5 text-slate-900 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white",value:h.level??"",onChange:e=>y(s=>({...s,level:e.target.value?Number(e.target.value):null}))})]}),t.jsxs("div",{children:[t.jsx("label",{className:"mb-2 block text-sm font-medium text-slate-700 dark:text-slate-300",children:"Location (Optional)"}),t.jsxs("select",{className:"w-full rounded-lg border border-slate-300 bg-white px-4 py-2.5 text-slate-900 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white",value:p?.location_id??j??"",onChange:e=>{if(p){const s=e.target.value?Number(e.target.value):null;E(a=>a?{...a,location_id:s}:null)}},disabled:!p&&!!j,children:[t.jsx("option",{value:"",children:"No location"}),ve.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]}),!p&&j&&t.jsx("p",{className:"mt-1 text-xs text-slate-500 dark:text-slate-400",children:"Location is set from URL parameter"})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"mb-2 block text-sm font-medium text-slate-700 dark:text-slate-300",children:"Plan Image Path or URL"}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("input",{type:"text",placeholder:"/storage/floor-plans/image.png or https://example.com/plan.jpg",className:"flex-1 rounded-lg border border-slate-300 bg-white px-4 py-2.5 text-sm text-slate-900 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white",value:h.plan_image_path??"",onChange:e=>y(s=>({...s,plan_image_path:e.target.value}))}),t.jsxs("label",{className:"inline-flex cursor-pointer items-center gap-2 rounded-lg border border-slate-300 bg-white px-4 py-2.5 text-sm font-medium text-slate-700 transition-all hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600",children:[t.jsx(fe,{className:"size-4"}),t.jsx("span",{className:"hidden sm:inline",children:"Upload"}),t.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:async e=>{const s=e.target.files?.[0];if(!s)return;const a=new FormData;a.append("image",s);const l=await fetch("/api/floor-plans/upload",{method:"POST",body:a});if(l.ok){const i=await l.json();y(r=>({...r,plan_image_path:i.path}))}else alert("Upload failed")}})]})]}),t.jsx("p",{className:"mt-1 text-xs text-slate-500 dark:text-slate-400",children:"Upload an image file or enter a URL/path to the floor plan image"})]}),h.plan_image_path&&t.jsx("div",{className:"rounded-lg border border-slate-200 bg-slate-50 p-3 dark:border-slate-700 dark:bg-slate-900/50",children:t.jsxs("div",{className:"flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400",children:[t.jsx(ae,{className:"size-4"}),t.jsx("span",{className:"truncate",children:h.plan_image_path})]})})]}),t.jsx("div",{className:"border-t border-slate-200 p-6 dark:border-slate-700",children:t.jsxs("div",{className:"flex items-center justify-end gap-3",children:[t.jsx("button",{onClick:G,className:"rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 transition-all hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600",children:"Cancel"}),t.jsxs("button",{onClick:p?Ne:je,disabled:re||!h.name.trim(),className:"inline-flex items-center gap-2 rounded-lg bg-gradient-to-r from-blue-600 to-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-lg transition-all hover:from-blue-700 hover:to-indigo-700 hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed",children:[t.jsx(Ae,{className:"size-4"}),re?"Saving...":p?"Update Floor":"Create Floor"]})]})})]})}),W&&t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4",onClick:()=>Y(null),children:t.jsxs("div",{className:"w-full max-w-md rounded-2xl border border-red-200 bg-white shadow-2xl dark:border-red-900/50 dark:bg-slate-800",onClick:e=>e.stopPropagation(),children:[t.jsx("div",{className:"border-b border-red-200 p-6 dark:border-red-900/50",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"rounded-full bg-red-100 p-3 dark:bg-red-900/30",children:t.jsx(se,{className:"size-6 text-red-600 dark:text-red-400"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-xl font-bold text-slate-900 dark:text-white",children:"Delete Floor"}),t.jsx("p",{className:"text-sm text-slate-600 dark:text-slate-400",children:"This action cannot be undone"})]})]})}),t.jsxs("div",{className:"p-6",children:[t.jsxs("p",{className:"text-slate-700 dark:text-slate-300",children:["Are you sure you want to delete ",t.jsx("strong",{children:P.find(e=>e.id===W)?.name}),"?"]}),t.jsx("p",{className:"mt-2 text-sm text-slate-600 dark:text-slate-400",children:"This will also delete all device positions on this floor."})]}),t.jsx("div",{className:"border-t border-red-200 p-6 dark:border-red-900/50",children:t.jsxs("div",{className:"flex items-center justify-end gap-3",children:[t.jsx("button",{onClick:()=>Y(null),className:"rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 transition-all hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600",children:"Cancel"}),t.jsxs("button",{onClick:()=>we(W),className:"inline-flex items-center gap-2 rounded-lg bg-red-600 px-4 py-2 text-sm font-medium text-white shadow-lg transition-all hover:bg-red-700 hover:shadow-xl",children:[t.jsx(se,{className:"size-4"}),"Delete Floor"]})]})})]})})]})}export{dt as default};
