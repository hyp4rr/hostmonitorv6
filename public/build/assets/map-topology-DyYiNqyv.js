import{b as Q,r as o,j as e}from"./app-B4fkVL-W.js";import{M as q,b as K,C as Z}from"./monitor-layout-X6KElx1m.js";import{L as f}from"./leaflet-47NS-zU3.js";import{g as J}from"./device-icons-DptdtEPD.js";import{S as X}from"./search-lVQvEiEL.js";import{L as z}from"./layers-D92U8RjD.js";import{C as Y}from"./chevron-up-D7DcPQoO.js";import{I as ee}from"./info-D-Bn7dWQ.js";import"./app-hK0G8rfC.js";import"./x-BxlU8eWN.js";import"./createLucideIcon-dVGcEtEt.js";import"./server-DqELNAlQ.js";import"./activity-6clVTxZj.js";import"./wifi-DG7M9WHp.js";function pe(){const{props:D}=Q(),{currentBranch:j}=D,c=o.useRef(null),y=o.useRef(null),k=o.useRef(new Map),m=o.useRef([]),[u,R]=o.useState([]),[p,A]=o.useState([]),[N,$]=o.useState(!0),[i,L]=o.useState(null),[C,M]=o.useState(null),[te,B]=o.useState(!1),[g,I]=o.useState("map"),[b,G]=o.useState(""),[w,F]=o.useState("all"),[v,T]=o.useState("all"),[d,H]=o.useState("location");o.useEffect(()=>{O()},[j?.id]);const O=async()=>{$(!0);try{const t=await(await fetch(`/api/devices?branch_id=${j?.id||"all"}&per_page=1000&include_inactive=true&active_filter=all`)).json(),a=t.data||t||[];R(a);const n=await(await fetch(`/api/locations?branch_id=${j?.id||"all"}`)).json();A(n||[])}catch(s){console.error("Failed to load data:",s)}finally{$(!1)}};o.useEffect(()=>{if(!y.current||c.current)return;const s=f.map(y.current,{center:[2.9,101.7],zoom:15,zoomControl:!0});return f.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap contributors",maxZoom:19}).addTo(s),c.current=s,()=>{c.current&&(c.current.remove(),c.current=null)}},[]);const U=o.useMemo(()=>{const s=new Map;return u.forEach(t=>{let a="",r="";d==="location"&&t.location?(a=`location-${t.location.id}`,r=t.location.name):d==="building"&&t.building?(a=`building-${t.building}`,r=t.building):d==="category"?(a=`category-${t.category}`,r=t.category.charAt(0).toUpperCase()+t.category.slice(1)):(a="ungrouped",r="Ungrouped"),s.has(a)||s.set(a,{name:r,type:d==="location"?"location":d==="building"?"building":"location",devices:[]}),s.get(a).devices.push(t)}),Array.from(s.values())},[u,d]),S=o.useMemo(()=>u.filter(s=>{const t=s.name.toLowerCase().includes(b.toLowerCase())||s.ip_address.toLowerCase().includes(b.toLowerCase()),a=w==="all"||s.status===w,r=v==="all"||s.category===v;return t&&a&&r}),[u,b,w,v]);o.useEffect(()=>{if(!c.current||N)return;k.current.forEach(t=>t.remove()),k.current.clear(),m.current.forEach(t=>t.remove()),m.current=[];const s=new Map;S.forEach(t=>{t.location_id&&(s.has(t.location_id)||s.set(t.location_id,[]),s.get(t.location_id).push(t))}),p.forEach(t=>{const a=s.get(t.id)||[];if(a.length===0)return;a.filter(h=>h.status==="online").length;const r=a.filter(h=>h.status==="warning").length,n=a.filter(h=>h.status==="offline"||h.status==="offline_ack").length,l=()=>n>0?"#ef4444":r>0?"#f59e0b":"#10b981",x=f.divIcon({className:"custom-device-marker",html:`
                    <div style="
                        background: ${l()};
                        width: 32px;
                        height: 32px;
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                        font-size: 12px;
                    ">
                        ${a.length}
                    </div>
                `,iconSize:[32,32],iconAnchor:[16,16]}),_=f.marker([t.latitude,t.longitude],{icon:x}).addTo(c.current).bindPopup(P(t,a)).on("click",()=>{M({name:t.name,type:"location",devices:a}),B(!0)});k.current.set(t.id,_)}),d==="location"&&V()},[S,p,N,d]);const P=(s,t)=>{const a=t.filter(l=>l.status==="online").length,r=t.filter(l=>l.status==="warning").length,n=t.filter(l=>l.status==="offline"||l.status==="offline_ack").length;return`
            <div style="min-width: 300px; max-width: 400px; font-family: system-ui;">
                <div style="font-weight: bold; font-size: 16px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0;">
                    ${s.name}
                </div>
                <div style="display: flex; gap: 16px; margin-bottom: 12px; font-size: 12px;">
                    <div style="color: #10b981; font-weight: 600;">ðŸŸ¢ ${a} Online</div>
                    <div style="color: #f59e0b; font-weight: 600;">ðŸŸ¡ ${r} Warning</div>
                    <div style="color: #ef4444; font-weight: 600;">ðŸ”´ ${n} Offline</div>
                </div>
                <div style="max-height: 300px; overflow-y: auto;">
                    ${t.slice(0,10).map(l=>`
                        <div style="padding: 8px; margin-bottom: 4px; background: #f8fafc; border-radius: 4px; cursor: pointer;" 
                             onclick="window.selectDevice(${l.id})">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #1e293b;">${l.name}</div>
                                    <div style="font-size: 11px; color: #64748b;">${l.ip_address}</div>
                                    ${l.model?`<div style="font-size: 10px; color: #94a3b8;">${l.model}</div>`:""}
                                </div>
                                <div style="
                                    width: 10px;
                                    height: 10px;
                                    border-radius: 50%;
                                    background: ${l.status==="online"?"#10b981":l.status==="warning"?"#f59e0b":"#ef4444"};
                                    box-shadow: 0 0 4px ${l.status==="online"?"#10b981":l.status==="warning"?"#f59e0b":"#ef4444"};
                                "></div>
                            </div>
                        </div>
                    `).join("")}
                    ${t.length>10?`<div style="text-align: center; color: #64748b; font-size: 11px; margin-top: 8px;">+${t.length-10} more devices</div>`:""}
                </div>
            </div>
        `},V=()=>{m.current.forEach(a=>a.remove()),m.current=[];const s=new Map;S.forEach(a=>{a.location_id&&(s.has(a.location_id)||s.set(a.location_id,[]),s.get(a.location_id).push(a))});const t=Array.from(s.keys());for(let a=0;a<t.length;a++)for(let r=a+1;r<t.length;r++){const n=p.find(x=>x.id===t[a]),l=p.find(x=>x.id===t[r]);if(n&&l&&Math.sqrt(Math.pow(n.latitude-l.latitude,2)+Math.pow(n.longitude-l.longitude,2))<.01){const _=f.polyline([[n.latitude,n.longitude],[l.latitude,l.longitude]],{color:"#22c55e",weight:3,opacity:.7}).addTo(c.current);m.current.push(_)}}};o.useEffect(()=>{window.selectDevice=s=>{const t=u.find(a=>a.id===s);t&&L(t)}},[u]);const E=s=>{switch(s){case"online":return e.jsx("div",{className:"w-3 h-3 bg-green-500 rounded-full shadow-lg shadow-green-500/50"});case"warning":return e.jsx("div",{className:"w-3 h-3 bg-yellow-500 rounded-full shadow-lg shadow-yellow-500/50"});case"offline":case"offline_ack":return e.jsx("div",{className:"w-3 h-3 bg-red-500 rounded-full shadow-lg shadow-red-500/50"});default:return e.jsx("div",{className:"w-3 h-3 bg-gray-500 rounded-full"})}},W=s=>{const t=J(s);return e.jsx(t,{className:"w-5 h-5"})};return e.jsx(q,{title:"Map Topology",children:e.jsxs("div",{className:"flex flex-col h-[calc(100vh-4rem)] gap-4 p-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-4 bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(X,{className:"w-5 h-5 text-slate-400"}),e.jsx("input",{type:"text",placeholder:"Search devices...",value:b,onChange:s=>G(s.target.value),className:"px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("select",{value:w,onChange:s=>F(s.target.value),className:"px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"all",children:"All Status"}),e.jsx("option",{value:"online",children:"Online"}),e.jsx("option",{value:"warning",children:"Warning"}),e.jsx("option",{value:"offline",children:"Offline"})]}),e.jsxs("select",{value:v,onChange:s=>T(s.target.value),className:"px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"all",children:"All Categories"}),e.jsx("option",{value:"switches",children:"Switches"}),e.jsx("option",{value:"servers",children:"Servers"}),e.jsx("option",{value:"wifi",children:"WiFi"}),e.jsx("option",{value:"tas",children:"TAS"}),e.jsx("option",{value:"cctv",children:"CCTV"})]}),e.jsxs("select",{value:d,onChange:s=>H(s.target.value),className:"px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"location",children:"Group by Location"}),e.jsx("option",{value:"building",children:"Group by Building"}),e.jsx("option",{value:"category",children:"Group by Category"})]}),e.jsxs("button",{onClick:()=>I(g==="map"?"hierarchy":"map"),className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2",children:[e.jsx(z,{className:"w-4 h-4"}),g==="map"?"Show Hierarchy":"Show Map"]})]}),e.jsxs("div",{className:"flex-1 flex gap-4",children:[g==="map"&&e.jsxs("div",{className:"flex-1 relative bg-slate-100 dark:bg-slate-900 rounded-lg overflow-hidden border border-slate-200 dark:border-slate-700",children:[e.jsx("div",{ref:y,className:"w-full h-full"}),N&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-white/80 dark:bg-slate-900/80 z-50",children:e.jsx("div",{className:"text-slate-600 dark:text-slate-400",children:"Loading map..."})})]}),g==="hierarchy"&&e.jsxs("div",{className:"flex-1 bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-6 overflow-y-auto",children:[e.jsx("h2",{className:"text-xl font-bold text-slate-900 dark:text-white mb-4",children:"Network Hierarchy"}),e.jsx("div",{className:"space-y-6",children:U.map((s,t)=>{const a=new Map;return s.devices.forEach(r=>{const n=r.building||"Ungrouped";a.has(n)||a.set(n,[]),a.get(n).push(r)}),e.jsxs("div",{className:"border-2 border-blue-200 dark:border-blue-800 rounded-lg p-5 bg-blue-50/30 dark:bg-blue-900/10",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(K,{className:"w-6 h-6 text-blue-600 dark:text-blue-400"}),e.jsx("h3",{className:"font-bold text-lg text-slate-900 dark:text-white",children:s.name}),e.jsxs("span",{className:"text-sm text-slate-600 dark:text-slate-400 bg-white dark:bg-slate-700 px-2 py-1 rounded",children:[s.devices.length," devices"]})]}),e.jsx("button",{onClick:()=>M(C?.name===s.name?null:s),className:"text-blue-600 hover:text-blue-700 dark:text-blue-400",children:C?.name===s.name?e.jsx(Y,{className:"w-5 h-5"}):e.jsx(Z,{className:"w-5 h-5"})})]}),C?.name===s.name&&e.jsx("div",{className:"mt-4 space-y-4",children:Array.from(a.entries()).map(([r,n])=>e.jsxs("div",{className:"bg-white dark:bg-slate-700 rounded-lg p-4 border border-slate-200 dark:border-slate-600",children:[e.jsxs("h4",{className:"font-semibold text-slate-900 dark:text-white mb-3 flex items-center gap-2",children:[e.jsx(z,{className:"w-4 h-4"}),r]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3",children:n.map(l=>e.jsxs("div",{onClick:()=>L(l),className:"flex items-start justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer border border-slate-200 dark:border-slate-600 transition-all",children:[e.jsxs("div",{className:"flex items-start gap-3 flex-1",children:[e.jsx("div",{className:"mt-1",children:W(l.category)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-semibold text-slate-900 dark:text-white text-sm mb-1",children:l.name}),e.jsx("div",{className:"text-xs text-slate-600 dark:text-slate-400 font-mono mb-1",children:l.ip_address}),l.model&&e.jsx("div",{className:"text-xs text-slate-500 dark:text-slate-500 truncate",children:l.model}),l.brand&&e.jsx("div",{className:"text-xs text-slate-500 dark:text-slate-500",children:l.brand})]})]}),e.jsx("div",{className:"ml-2 flex-shrink-0",children:E(l.status)})]},l.id))})]},r))})]},t)})})]}),e.jsxs("div",{className:"w-96 bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-6 overflow-y-auto",children:[e.jsx("h2",{className:"text-xl font-bold text-slate-900 dark:text-white mb-4",children:"Device Details"}),i?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900 dark:text-white",children:i.name}),E(i.status)]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-slate-600 dark:text-slate-400",children:"IP Address"}),e.jsx("p",{className:"text-slate-900 dark:text-white font-mono",children:i.ip_address})]}),i.model&&e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-slate-600 dark:text-slate-400",children:"Model"}),e.jsx("p",{className:"text-slate-900 dark:text-white",children:i.model})]}),i.brand&&e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-slate-600 dark:text-slate-400",children:"Brand"}),e.jsx("p",{className:"text-slate-900 dark:text-white",children:i.brand})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-slate-600 dark:text-slate-400",children:"Category"}),e.jsx("p",{className:"text-slate-900 dark:text-white capitalize",children:i.category})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-slate-600 dark:text-slate-400",children:"Status"}),e.jsx("p",{className:"text-slate-900 dark:text-white capitalize",children:i.status})]}),i.uptime_percentage!==void 0&&e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-slate-600 dark:text-slate-400",children:"Uptime"}),e.jsxs("p",{className:"text-slate-900 dark:text-white",children:[i.uptime_percentage.toFixed(2),"%"]})]})]})]}):e.jsxs("div",{className:"text-center text-slate-500 dark:text-slate-400 py-8",children:[e.jsx(ee,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Select a device to view details"})]})]})]})]})})}export{pe as default};
