import{b as $e,r as n,j as t,c as ue}from"./app-DsbjyKGf.js";import{M as Ee,b as Te}from"./monitor-layout-Dq_xIMSU.js";import{g as Ue}from"./device-icons-Bh4xq8HI.js";import{c as z}from"./createLucideIcon-BnSOlFpd.js";import{P as xe,S as G,T as K}from"./trash-2-BhV61ii_.js";import{L as he}from"./layers-C5lq39nl.js";import{S as pe}from"./server-Ca-qE3nK.js";import{X as Le}from"./x-8qECKafY.js";import{S as Re}from"./save-DHSylOx8.js";import"./app-DiM3Qhuw.js";import"./activity-BRPubSy7.js";import"./wifi-Ccv0dO_b.js";/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ie=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],Ae=z("ArrowLeft",Ie);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oe=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]],ee=z("Image",Oe);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xe=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]],Ye=z("RotateCcw",Xe);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]],ge=z("Upload",Be);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ze=[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"11",x2:"11",y1:"8",y2:"14",key:"1vmskp"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]],We=z("ZoomIn",Ze);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]],He=z("ZoomOut",qe);function it(){const{currentBranch:y}=$e().props,_=n.useMemo(()=>new URLSearchParams(window.location.search),[]),j=n.useMemo(()=>{const e=_.get("location_id");return e?Number(e):null},[_]),I=n.useMemo(()=>{const e=_.get("floor_id");return e?Number(e):null},[_]),A=n.useMemo(()=>{const e=_.get("deviceId");return e?Number(e):null},[_]),u=n.useMemo(()=>_.get("mode")==="config",[_]),[C,D]=n.useState([]),[d,S]=n.useState(null),[F,N]=n.useState([]),[te,ae]=n.useState([]),[$,se]=n.useState(""),[le,O]=n.useState(!1),[x,w]=n.useState({name:""}),[h,E]=n.useState(null),[fe,T]=n.useState(!1),[B,X]=n.useState(null),[be,re]=n.useState([]),[g,U]=n.useState(null),f=n.useRef(null),[L,Z]=n.useState(1),[P,W]=n.useState(0),[M,q]=n.useState(0),[H,R]=n.useState(!1),[ne,oe]=n.useState(!1),b=n.useRef(null),ve=n.useRef(null),v=n.useRef(null),c=n.useRef(null),p=n.useMemo(()=>C.find(e=>e.id===d)||null,[C,d]);n.useEffect(()=>{const e=y?.id?String(y.id):null,a=e==="all"?"/api/locations":e?`/api/locations?branch_id=${e}`:"/api/locations";fetch(a,{credentials:"same-origin",headers:{Accept:"application/json"}}).then(s=>s.ok?s.json():[]).then(re).catch(()=>re([]))},[y?.id]),n.useEffect(()=>{const e=new URLSearchParams,a=y?.id?String(y.id):null;a&&a!=="all"&&e.set("branch_id",a),j&&e.set("location_id",String(j));const s=e.toString()?`/api/floors?${e.toString()}`:"/api/floors";console.log("Fetching floors from:",s),fetch(s).then(r=>r.json()).then(r=>{console.log("Floors loaded:",r.length,r),D(r),I&&r.some(o=>o.id===I)?S(I):r.length>0?S(r[0].id):S(null)}).catch(r=>{console.error("Error loading floors:",r),D([])});const l=new URLSearchParams;l.set("per_page","1000"),a&&a!=="all"&&l.set("branch_id",a);const i=l.toString()?`/api/devices?${l.toString()}`:"/api/devices?per_page=1000";fetch(i).then(r=>r.json()).then(r=>{const o=r?.data||[];ae(o),A&&o.some(m=>m.id===A)&&se(A)}).catch(()=>ae([]))},[y?.id,j,I,A]),n.useEffect(()=>{d&&fetch(`/api/device-positions?floor_id=${d}`).then(e=>e.json()).then(N).catch(()=>N([]))},[d]),n.useEffect(()=>()=>{c.current!==null&&(cancelAnimationFrame(c.current),c.current=null)},[]);const ie=async e=>{try{const a=await fetch("/api/device-positions/upsert",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"same-origin",body:JSON.stringify(e)});if(!a.ok){const l=await a.text().catch(()=>"");console.error("Save position failed:",a.status,l),alert(`Failed to save position (${a.status}).`);return}const s=await a.json();N(l=>{const i=l.findIndex(r=>r.device_id===s.device_id&&r.floor_id===s.floor_id);if(i>=0){const r=l.slice();return r[i]=s,r}return[...l,s]}),d&&fetch(`/api/device-positions?floor_id=${d}`).then(l=>l.json()).then(N).catch(()=>N([]))}catch(a){console.error("Save position error:",a),alert("Network error while saving position")}},ke=async()=>{if(x.name.trim()){O(!0);try{const e=y?.id?String(y.id):null,a=await fetch("/api/floors",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({branch_id:e&&e!=="all"?typeof e=="string"?parseInt(e):e:null,location_id:j||null,name:x.name.trim(),level:x.level??null,plan_image_path:x.plan_image_path||null})});if(a.ok){const s=await a.json();D(l=>[...l,s].sort((i,r)=>(i.level??0)-(r.level??0))),S(s.id),w({name:""}),T(!1)}else{const s=await a.json().catch(()=>({message:"Failed to create floor"}));alert(s.message||"Failed to create floor")}}catch(e){console.error("Error creating floor:",e),alert("Network error while creating floor")}finally{O(!1)}}},je=async()=>{if(!(!h||!x.name.trim())){O(!0);try{const e=await fetch(`/api/floors/${h.id}`,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({branch_id:h.branch_id,location_id:h.location_id,name:x.name.trim(),level:x.level??null,plan_image_path:x.plan_image_path||null})});if(e.ok){const a=await e.json();D(s=>s.map(l=>l.id===a.id?a:l).sort((l,i)=>(l.level??0)-(i.level??0))),E(null),w({name:""}),T(!1),d===a.id&&(S(null),setTimeout(()=>S(a.id),0))}else{const a=await e.json().catch(()=>({message:"Failed to update floor"})),s=a.message||a.error||"Failed to update floor";alert(s)}}catch(e){console.error("Error updating floor:",e),alert("Network error while updating floor")}finally{O(!1)}}},Ne=async e=>{try{const a=await fetch(`/api/floors/${e}`,{method:"DELETE",headers:{Accept:"application/json"},credentials:"same-origin"});if(a.ok||a.status===204)D(s=>s.filter(l=>l.id!==e)),d===e&&S(null),X(null);else{const s=await a.text().catch(()=>"Failed to delete floor");alert(`Failed to delete floor: ${s}`)}}catch(a){console.error("Error deleting floor:",a),alert("Network error while deleting floor")}},de=e=>{E({...e}),w({name:e.name,level:e.level??null,plan_image_path:e.plan_image_path??""}),T(!0)},ce=()=>{E(null),w({name:"",level:null,plan_image_path:""}),T(!0)},J=()=>{T(!1),E(null),w({name:""})},we=async e=>{if(!u||!d||!$||typeof $!="number")return;const a=e.target;if(a.tagName==="BUTTON"||a.closest("button")||a.closest("[data-device-marker]")||!v.current)return;e.preventDefault(),e.stopPropagation();const s=v.current.getBoundingClientRect(),l=L,i=s.width*(1-l)/2-P,r=s.height*(1-l)/2-M;let o=(e.clientX-s.left-i)/(s.width*l),m=(e.clientY-s.top-r)/(s.height*l);o=Math.min(1,Math.max(0,o)),m=Math.min(1,Math.max(0,m)),await ie({floor_id:d,device_id:$,x:o,y:m})},ye=e=>({left:`${e.x*100}%`,top:`${e.y*100}%`,transform:"translate(-50%, -100%)"}),Y=e=>te.find(a=>a.id===e)?.name||`#${e}`,_e=()=>{Z(e=>Math.min(e+.25,3))},Se=()=>{Z(e=>Math.max(e-.25,.5))},Fe=()=>{Z(1),W(0),q(0)},Ce=e=>{const a=e.target;a.closest("[data-device-marker]")||a.tagName==="BUTTON"||a.closest("button")||g||(e.button===1||e.button===2||e.button===0&&ne)&&(e.preventDefault(),e.stopPropagation(),R(!0),b.current={x:e.clientX-P,y:e.clientY-M})},me=()=>{R(!1),b.current=null},Pe=e=>{const a=e.target;if(!(a.closest("[data-device-marker]")||a.tagName==="BUTTON"||a.closest("button"))&&!g&&e.touches.length===1){e.preventDefault(),e.stopPropagation();const s=e.touches[0];R(!0),b.current={x:s.clientX-P,y:s.clientY-M}}},Me=e=>{if(H&&b.current&&e.touches.length===1){e.preventDefault(),e.stopPropagation();const a=e.touches[0];W(a.clientX-b.current.x),q(a.clientY-b.current.y)}},ze=()=>{R(!1),b.current=null};return n.useEffect(()=>{const e=s=>{s.key===" "&&(s.preventDefault(),oe(!0))},a=s=>{s.key===" "&&(oe(!1),R(!1),b.current=null)};return window.addEventListener("keydown",e),window.addEventListener("keyup",a),()=>{window.removeEventListener("keydown",e),window.removeEventListener("keyup",a)}},[]),t.jsxs(Ee,{title:"Floor Plan",children:[t.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[t.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("button",{onClick:()=>{j?ue.visit(`/monitor/maps?location_id=${j}`):ue.visit("/monitor/maps")},className:"inline-flex items-center justify-center gap-2 rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-medium text-slate-700 transition-all hover:bg-slate-50 hover:shadow-sm dark:border-slate-600 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600",title:"Go back to maps",children:[t.jsx(Ae,{className:"size-4"}),t.jsx("span",{className:"hidden sm:inline",children:"Back"})]}),t.jsxs("div",{children:[t.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-slate-900 dark:text-white",children:"Floor Plan Management"}),t.jsx("p",{className:"mt-1 text-sm text-slate-600 dark:text-slate-400",children:u?"Manage floor plans and device positions":"View floor plans and device locations"})]})]}),u&&t.jsxs("button",{onClick:ce,className:"inline-flex items-center gap-2 rounded-lg bg-gradient-to-r from-blue-600 to-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-lg transition-all hover:from-blue-700 hover:to-indigo-700 hover:shadow-xl",children:[t.jsx(xe,{className:"size-4"}),t.jsx("span",{children:"New Floor"})]})]}),t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-4",children:[t.jsx("div",{className:"lg:col-span-1",children:t.jsxs("div",{className:"rounded-xl border border-slate-200 bg-white shadow-lg dark:border-slate-700 dark:bg-slate-800",children:[t.jsx("div",{className:"border-b border-slate-200 p-4 dark:border-slate-700",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(he,{className:"size-5 text-blue-600 dark:text-blue-400"}),t.jsx("h2",{className:"text-lg font-semibold text-slate-900 dark:text-white",children:"Floors"}),t.jsx("span",{className:"ml-auto rounded-full bg-slate-100 px-2.5 py-0.5 text-xs font-semibold text-slate-600 dark:bg-slate-700 dark:text-slate-400",children:C.length})]})}),t.jsx("div",{className:"max-h-[400px] overflow-y-auto p-2",children:C.length===0?t.jsxs("div",{className:"p-8 text-center",children:[t.jsx(he,{className:"mx-auto mb-3 size-10 text-slate-400"}),t.jsx("p",{className:"text-sm text-slate-600 dark:text-slate-400",children:"No floors found"}),u&&t.jsx("button",{onClick:ce,className:"mt-3 text-sm text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300",children:"Create your first floor"})]}):t.jsx("div",{className:"space-y-2",children:C.map(e=>t.jsx("div",{className:`group relative rounded-lg border-2 p-3 transition-all cursor-pointer ${d===e.id?"border-blue-500 bg-blue-50 dark:bg-blue-950/20 shadow-md":"border-slate-200 bg-slate-50 hover:border-slate-300 hover:bg-slate-100 dark:border-slate-700 dark:bg-slate-900/50 dark:hover:bg-slate-800"}`,onClick:()=>S(e.id),children:t.jsxs("div",{className:"flex items-start justify-between gap-2",children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[e.level!==null&&t.jsxs("span",{className:"flex-shrink-0 rounded bg-blue-100 px-1.5 py-0.5 text-xs font-bold text-blue-700 dark:bg-blue-900/50 dark:text-blue-300",children:["L",e.level]}),t.jsx("h3",{className:"truncate font-semibold text-slate-900 dark:text-white",children:e.name})]}),e.plan_image_path&&t.jsxs("div",{className:"mt-1 flex items-center gap-1 text-xs text-slate-500 dark:text-slate-400",children:[t.jsx(ee,{className:"size-3"}),t.jsx("span",{className:"truncate",children:"Plan image set"})]}),F.filter(a=>a.floor_id===e.id).length>0&&t.jsxs("div",{className:"mt-1 text-xs text-slate-500 dark:text-slate-400",children:[F.filter(a=>a.floor_id===e.id).length," device",F.filter(a=>a.floor_id===e.id).length!==1?"s":""]})]}),u&&t.jsxs("div",{className:"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[t.jsx("button",{onClick:a=>{a.stopPropagation(),de(e)},className:"rounded p-1.5 text-blue-600 hover:bg-blue-100 dark:text-blue-400 dark:hover:bg-blue-900/50",title:"Edit floor",children:t.jsx(G,{className:"size-4"})}),t.jsx("button",{onClick:a=>{a.stopPropagation(),X(e.id)},className:"rounded p-1.5 text-red-600 hover:bg-red-100 dark:text-red-400 dark:hover:bg-red-900/50",title:"Delete floor",children:t.jsx(K,{className:"size-4"})})]})]})},e.id))})})]})}),t.jsxs("div",{className:"lg:col-span-3 space-y-4",children:[u&&d&&t.jsx("div",{className:"rounded-xl border border-slate-200 bg-gradient-to-r from-slate-50 to-slate-100 p-4 dark:border-slate-700 dark:from-slate-900/50 dark:to-slate-800/50",children:t.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(pe,{className:"size-5 text-blue-600 dark:text-blue-400"}),t.jsx("span",{className:"text-sm font-semibold text-slate-700 dark:text-slate-300",children:"Place Device on Floor"})]}),t.jsxs("select",{className:"flex-1 w-full sm:w-auto rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-700 dark:text-white",value:$||"",onChange:e=>se(e.target.value?Number(e.target.value):""),children:[t.jsx("option",{value:"",children:"â€” Select Device â€”"}),te.map(e=>t.jsxs("option",{value:e.id,children:[e.name," (",e.ip_address,")"]},e.id))]}),$&&t.jsx("p",{className:"text-xs text-slate-600 dark:text-slate-400",children:"Click on the plan to place this device"})]})}),t.jsx("div",{className:"relative",children:t.jsxs("div",{ref:v,onClick:we,onMouseDown:Ce,onTouchStart:Pe,onTouchMove:Me,onTouchEnd:ze,onMouseMove:e=>{if(H&&b.current){e.preventDefault(),e.stopPropagation(),W(e.clientX-b.current.x),q(e.clientY-b.current.y);return}u&&(!g||!d||!v.current||(e.preventDefault(),e.stopPropagation(),c.current!==null&&cancelAnimationFrame(c.current),c.current=requestAnimationFrame(()=>{if(!v.current)return;const a=v.current.getBoundingClientRect(),s=L,l=a.width*(1-s)/2-P,i=a.height*(1-s)/2-M;let r=(e.clientX-a.left-l)/(a.width*s),o=(e.clientY-a.top-i)/(a.height*s);f.current&&(r-=f.current.x,o-=f.current.y),r=Math.min(1,Math.max(0,r)),o=Math.min(1,Math.max(0,o)),N(m=>m.map(k=>k.device_id===g?{...k,x:r,y:o}:k)),c.current=null})))},onMouseUp:async e=>{if(me(),!u||!g||!d||!v.current)return;const a=e.target;if(a.tagName==="BUTTON"||a.closest("button")){U(null),f.current=null,c.current!==null&&(cancelAnimationFrame(c.current),c.current=null);return}e.preventDefault(),e.stopPropagation(),c.current!==null&&(cancelAnimationFrame(c.current),c.current=null);const s=v.current.getBoundingClientRect(),l=L,i=s.width*(1-l)/2-P,r=s.height*(1-l)/2-M;let o=(e.clientX-s.left-i)/(s.width*l),m=(e.clientY-s.top-r)/(s.height*l);f.current&&(o-=f.current.x,m-=f.current.y),o=Math.min(1,Math.max(0,o)),m=Math.min(1,Math.max(0,m));const k=F.find(Q=>Q.device_id===g);if(!window.confirm(`Move ${k?Y(k.device_id):"device"} to (${(o*100).toFixed(1)}%, ${(m*100).toFixed(1)}%)?`)){k&&N(Q=>Q.map(V=>V.device_id===k.device_id?{...V,x:k.x,y:k.y}:V)),U(null),f.current=null;return}const De={floor_id:d,device_id:g,x:o,y:m,marker_type:void 0};U(null),f.current=null,await ie(De)},onMouseLeave:e=>{if(me(),g&&u){c.current!==null&&(cancelAnimationFrame(c.current),c.current=null);const a=F.find(s=>s.device_id===g);a&&N(s=>s.map(l=>l.device_id===a.device_id?{...l,x:a.x,y:a.y}:l)),U(null),f.current=null}},className:"relative w-full overflow-hidden rounded-xl border border-slate-200 bg-slate-50 dark:border-slate-700 dark:bg-slate-900 touch-pan-y touch-pan-x",style:{aspectRatio:"16 / 10",minHeight:"300px",userSelect:"none",WebkitUserSelect:"none",WebkitTouchCallout:"none",touchAction:"pan-x pan-y",cursor:H?"grabbing":ne?"grab":g?"grabbing":"default"},children:[t.jsxs("div",{className:"absolute right-2 sm:right-4 top-2 sm:top-4 z-20 flex flex-col gap-1 sm:gap-1.5 rounded-lg bg-white/95 backdrop-blur-sm border border-slate-200/50 p-1.5 sm:p-2 shadow-xl dark:bg-slate-800/95 dark:border-slate-700/50",onClick:e=>e.stopPropagation(),children:[t.jsx("button",{onClick:e=>{e.stopPropagation(),_e()},className:"rounded-md border border-slate-300 p-1.5 sm:p-1.5 hover:bg-slate-100 active:scale-95 transition-all dark:border-slate-600 dark:hover:bg-slate-700 touch-manipulation",title:"Zoom In",children:t.jsx(We,{className:"size-4 sm:size-4"})}),t.jsx("button",{onClick:e=>{e.stopPropagation(),Se()},className:"rounded-md border border-slate-300 p-1.5 sm:p-1.5 hover:bg-slate-100 active:scale-95 transition-all dark:border-slate-600 dark:hover:bg-slate-700 touch-manipulation",title:"Zoom Out",children:t.jsx(He,{className:"size-4 sm:size-4"})}),t.jsx("button",{onClick:e=>{e.stopPropagation(),Fe()},className:"rounded-md border border-slate-300 p-1.5 sm:p-1.5 hover:bg-slate-100 active:scale-95 transition-all dark:border-slate-600 dark:hover:bg-slate-700 touch-manipulation",title:"Reset Zoom",children:t.jsx(Ye,{className:"size-4 sm:size-4"})}),t.jsxs("div",{className:"px-1.5 py-1 text-center text-[10px] font-semibold text-slate-600 dark:text-slate-400 border-t border-slate-200 dark:border-slate-700 mt-0.5",children:[Math.round(L*100),"%"]})]}),t.jsxs("div",{style:{transform:`translate(${P}px, ${M}px) scale(${L})`,transformOrigin:"top left",width:"100%",height:"100%"},children:[p?.plan_image_path?t.jsx("img",{ref:ve,src:p.plan_image_path,className:"h-full w-full object-contain select-none",style:{userSelect:"none",WebkitUserSelect:"none",pointerEvents:"none"},alt:p.name,draggable:!1}):t.jsxs("div",{className:"absolute inset-0 flex items-center justify-center text-slate-500 dark:text-slate-400",children:[t.jsx(ge,{className:"mr-2 size-5"})," Select a floor with a plan image"]}),p&&F.map(e=>t.jsx("div",{"data-device-marker":!0,className:`absolute ${u?"cursor-move group":"cursor-default"}`,style:{...ye(e),userSelect:"none",WebkitUserSelect:"none",pointerEvents:"auto"},title:`${Y(e.device_id)} @ (${(e.x*100).toFixed(1)}%, ${(e.y*100).toFixed(1)}%)`,onMouseDown:a=>{if(a.preventDefault(),a.stopPropagation(),u&&v.current){const s=v.current.getBoundingClientRect();a.currentTarget.getBoundingClientRect();const i=a.clientX-s.left,r=a.clientY-s.top,o=e.x*s.width,m=e.y*s.height;f.current={x:(i-o)/s.width,y:(r-m)/s.height},U(e.device_id)}},draggable:!1,children:t.jsxs("div",{className:"relative flex -translate-y-1/2 flex-col items-center select-none",style:{userSelect:"none",WebkitUserSelect:"none"},children:[t.jsx("div",{className:"rounded bg-white/90 px-2 py-0.5 text-[10px] font-medium shadow dark:bg-slate-800/90 select-none",style:{userSelect:"none",WebkitUserSelect:"none"},children:Y(e.device_id)}),t.jsx("div",{className:`mt-1 rounded-full p-1.5 shadow ring-2 ring-white/60 dark:ring-slate-900/60 select-none relative animate-pulse ${e.device?.status==="online"?"bg-green-600 text-white":e.device?.status==="warning"?"bg-yellow-500 text-white":"bg-red-600 text-white"}`,style:{userSelect:"none",WebkitUserSelect:"none",boxShadow:e.device?.status==="online"?"0 0 15px rgba(34, 197, 94, 0.8), 0 0 30px rgba(34, 197, 94, 0.5), 0 0 45px rgba(34, 197, 94, 0.3)":e.device?.status==="warning"?"0 0 15px rgba(234, 179, 8, 0.8), 0 0 30px rgba(234, 179, 8, 0.5), 0 0 45px rgba(234, 179, 8, 0.3)":"0 0 15px rgba(220, 38, 38, 0.8), 0 0 30px rgba(220, 38, 38, 0.5), 0 0 45px rgba(220, 38, 38, 0.3)"},children:(()=>{const a=Ue(e.device?.category||"");return t.jsx(a,{className:"size-5"})})()}),u&&g!==e.device_id&&t.jsx("button",{onClick:async a=>{if(a.preventDefault(),a.stopPropagation(),!confirm(`Remove ${Y(e.device_id)} from this floor?`))return;const s=await fetch(`/api/device-positions/${e.id}`,{method:"DELETE",headers:{Accept:"application/json"},credentials:"same-origin"});if(s.status===204||s.ok)N(l=>l.filter(i=>i.id!==e.id));else{const l=await s.text().catch(()=>"");alert(`Failed to delete position (${s.status}). ${l}`)}},onMouseDown:a=>{a.preventDefault(),a.stopPropagation()},className:"absolute -bottom-6 left-1/2 -translate-x-1/2 hidden rounded bg-red-600 px-1.5 py-0.5 text-[10px] font-semibold text-white shadow hover:bg-red-700 group-hover:block z-10",title:"Delete pin",children:"Delete"})]})},e.device_id))]})]})}),p&&t.jsx("div",{className:"rounded-xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("h3",{className:"text-lg font-semibold text-slate-900 dark:text-white",children:p.name}),t.jsxs("div",{className:"mt-1 flex flex-wrap items-center gap-3 text-sm text-slate-600 dark:text-slate-400",children:[p.level!==null&&t.jsxs("span",{className:"flex items-center gap-1",children:[t.jsx(Te,{className:"size-4"}),"Level ",p.level]}),t.jsxs("span",{className:"flex items-center gap-1",children:[t.jsx(pe,{className:"size-4"}),F.filter(e=>e.floor_id===p.id).length," device",F.filter(e=>e.floor_id===p.id).length!==1?"s":""]}),p.plan_image_path&&t.jsxs("span",{className:"flex items-center gap-1 text-green-600 dark:text-green-400",children:[t.jsx(ee,{className:"size-4"}),"Plan image loaded"]})]})]}),u&&t.jsx("div",{className:"flex items-center gap-2",children:t.jsxs("button",{onClick:()=>de(p),className:"inline-flex items-center gap-2 rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-medium text-slate-700 transition-all hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600",children:[t.jsx(G,{className:"size-4"}),t.jsx("span",{className:"hidden sm:inline",children:"Edit"})]})})]})})]})]}),t.jsx("div",{className:"rounded-lg border border-slate-200 bg-slate-50 p-3 dark:border-slate-700 dark:bg-slate-800/50",children:t.jsx("p",{className:"text-xs text-slate-600 dark:text-slate-400",children:u?t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"hidden sm:inline",children:"ðŸ’¡ Tip: Use zoom buttons to zoom. Pan with middle mouse button, right mouse button, or Space + drag. Select a device and click on the plan to place it."}),t.jsx("span",{className:"sm:hidden",children:"ðŸ’¡ Tip: Use zoom buttons to zoom. Touch and drag to pan. Select a device and tap on the plan to place it."})]}):t.jsxs(t.Fragment,{children:[t.jsxs("span",{className:"hidden sm:inline",children:["View-only mode. Add ",t.jsx("code",{className:"rounded bg-slate-200 px-1 py-0.5 text-[10px] dark:bg-slate-700",children:"?mode=config"})," to the URL to enable editing."]}),t.jsx("span",{className:"sm:hidden",children:"View-only mode. Add ?mode=config to enable editing."})]})})})]}),fe&&t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4",onClick:J,children:t.jsxs("div",{className:"w-full max-w-2xl rounded-2xl border border-slate-200 bg-white shadow-2xl dark:border-slate-700 dark:bg-slate-800",onClick:e=>e.stopPropagation(),children:[t.jsx("div",{className:"border-b border-slate-200 p-6 dark:border-slate-700",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 p-2",children:h?t.jsx(G,{className:"size-5 text-white"}):t.jsx(xe,{className:"size-5 text-white"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-xl font-bold text-slate-900 dark:text-white",children:h?"Edit Floor":"Create New Floor"}),t.jsx("p",{className:"text-sm text-slate-600 dark:text-slate-400",children:h?"Update floor details and plan image":"Add a new floor plan to the system"})]})]}),t.jsx("button",{onClick:J,className:"rounded-lg p-2 text-slate-500 transition-all hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-700",children:t.jsx(Le,{className:"size-5"})})]})}),t.jsxs("div",{className:"p-6 space-y-4",children:[t.jsxs("div",{children:[t.jsxs("label",{className:"mb-2 block text-sm font-medium text-slate-700 dark:text-slate-300",children:["Floor Name ",t.jsx("span",{className:"text-red-500",children:"*"})]}),t.jsx("input",{type:"text",placeholder:"e.g., Block A - Level 2, Main Building - Ground Floor",className:"w-full rounded-lg border border-slate-300 bg-white px-4 py-2.5 text-slate-900 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white",value:x.name,onChange:e=>w(a=>({...a,name:e.target.value}))})]}),t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"mb-2 block text-sm font-medium text-slate-700 dark:text-slate-300",children:"Level (Optional)"}),t.jsx("input",{type:"number",placeholder:"e.g., 0, 1, 2, -1",className:"w-full rounded-lg border border-slate-300 bg-white px-4 py-2.5 text-slate-900 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white",value:x.level??"",onChange:e=>w(a=>({...a,level:e.target.value?Number(e.target.value):null}))})]}),t.jsxs("div",{children:[t.jsx("label",{className:"mb-2 block text-sm font-medium text-slate-700 dark:text-slate-300",children:"Location (Optional)"}),t.jsxs("select",{className:"w-full rounded-lg border border-slate-300 bg-white px-4 py-2.5 text-slate-900 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white",value:h?.location_id??j??"",onChange:e=>{if(h){const a=e.target.value?Number(e.target.value):null;E(s=>s?{...s,location_id:a}:null)}},disabled:!h&&!!j,children:[t.jsx("option",{value:"",children:"No location"}),be.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]}),!h&&j&&t.jsx("p",{className:"mt-1 text-xs text-slate-500 dark:text-slate-400",children:"Location is set from URL parameter"})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"mb-2 block text-sm font-medium text-slate-700 dark:text-slate-300",children:"Plan Image Path or URL"}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("input",{type:"text",placeholder:"/storage/floor-plans/image.png or https://example.com/plan.jpg",className:"flex-1 rounded-lg border border-slate-300 bg-white px-4 py-2.5 text-sm text-slate-900 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white",value:x.plan_image_path??"",onChange:e=>w(a=>({...a,plan_image_path:e.target.value}))}),t.jsxs("label",{className:"inline-flex cursor-pointer items-center gap-2 rounded-lg border border-slate-300 bg-white px-4 py-2.5 text-sm font-medium text-slate-700 transition-all hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600",children:[t.jsx(ge,{className:"size-4"}),t.jsx("span",{className:"hidden sm:inline",children:"Upload"}),t.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:async e=>{const a=e.target.files?.[0];if(!a)return;const s=new FormData;s.append("image",a);const l=await fetch("/api/floor-plans/upload",{method:"POST",body:s});if(l.ok){const i=await l.json();w(r=>({...r,plan_image_path:i.path}))}else alert("Upload failed")}})]})]}),t.jsx("p",{className:"mt-1 text-xs text-slate-500 dark:text-slate-400",children:"Upload an image file or enter a URL/path to the floor plan image"})]}),x.plan_image_path&&t.jsx("div",{className:"rounded-lg border border-slate-200 bg-slate-50 p-3 dark:border-slate-700 dark:bg-slate-900/50",children:t.jsxs("div",{className:"flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400",children:[t.jsx(ee,{className:"size-4"}),t.jsx("span",{className:"truncate",children:x.plan_image_path})]})})]}),t.jsx("div",{className:"border-t border-slate-200 p-6 dark:border-slate-700",children:t.jsxs("div",{className:"flex items-center justify-end gap-3",children:[t.jsx("button",{onClick:J,className:"rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 transition-all hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600",children:"Cancel"}),t.jsxs("button",{onClick:h?je:ke,disabled:le||!x.name.trim(),className:"inline-flex items-center gap-2 rounded-lg bg-gradient-to-r from-blue-600 to-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-lg transition-all hover:from-blue-700 hover:to-indigo-700 hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed",children:[t.jsx(Re,{className:"size-4"}),le?"Saving...":h?"Update Floor":"Create Floor"]})]})})]})}),B&&t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4",onClick:()=>X(null),children:t.jsxs("div",{className:"w-full max-w-md rounded-2xl border border-red-200 bg-white shadow-2xl dark:border-red-900/50 dark:bg-slate-800",onClick:e=>e.stopPropagation(),children:[t.jsx("div",{className:"border-b border-red-200 p-6 dark:border-red-900/50",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"rounded-full bg-red-100 p-3 dark:bg-red-900/30",children:t.jsx(K,{className:"size-6 text-red-600 dark:text-red-400"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-xl font-bold text-slate-900 dark:text-white",children:"Delete Floor"}),t.jsx("p",{className:"text-sm text-slate-600 dark:text-slate-400",children:"This action cannot be undone"})]})]})}),t.jsxs("div",{className:"p-6",children:[t.jsxs("p",{className:"text-slate-700 dark:text-slate-300",children:["Are you sure you want to delete ",t.jsx("strong",{children:C.find(e=>e.id===B)?.name}),"?"]}),t.jsx("p",{className:"mt-2 text-sm text-slate-600 dark:text-slate-400",children:"This will also delete all device positions on this floor."})]}),t.jsx("div",{className:"border-t border-red-200 p-6 dark:border-red-900/50",children:t.jsxs("div",{className:"flex items-center justify-end gap-3",children:[t.jsx("button",{onClick:()=>X(null),className:"rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 transition-all hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600",children:"Cancel"}),t.jsxs("button",{onClick:()=>Ne(B),className:"inline-flex items-center gap-2 rounded-lg bg-red-600 px-4 py-2 text-sm font-medium text-white shadow-lg transition-all hover:bg-red-700 hover:shadow-xl",children:[t.jsx(K,{className:"size-4"}),"Delete Floor"]})]})})]})})]})}export{it as default};
