import{b as Ye,r as n,j as t,c as je}from"./app-B4fkVL-W.js";import{M as Ie,b as Ae}from"./monitor-layout-X6KElx1m.js";import{g as Oe}from"./device-icons-DptdtEPD.js";import{c as G}from"./createLucideIcon-dVGcEtEt.js";import{P as Ne,S as le,T as ne,U as ye}from"./upload-apSv_Ahe.js";import{L as we}from"./layers-D92U8RjD.js";import{S as _e}from"./server-DqELNAlQ.js";import{R as Be}from"./rotate-ccw-CKD9Ro4J.js";import{X as Ke}from"./x-BxlU8eWN.js";import{S as Ze}from"./save-DSWTMF-c.js";import"./app-hK0G8rfC.js";import"./activity-6clVTxZj.js";import"./wifi-DG7M9WHp.js";/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const We=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],Je=G("ArrowLeft",We);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qe=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]],oe=G("Image",Qe);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ve=[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"11",x2:"11",y1:"8",y2:"14",key:"1vmskp"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]],qe=G("ZoomIn",Ve);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ge=[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]],He=G("ZoomOut",Ge);function ht(){const{currentBranch:S}=Ye().props,C=n.useMemo(()=>new URLSearchParams(window.location.search),[]),N=n.useMemo(()=>{const e=C.get("location_id");return e?Number(e):null},[C]),Y=n.useMemo(()=>{const e=C.get("floor_id");return e?Number(e):null},[C]),I=n.useMemo(()=>{const e=C.get("deviceId");return e?Number(e):null},[C]),x=n.useMemo(()=>C.get("mode")==="config",[C]),[z,E]=n.useState([]),[d,P]=n.useState(null),[M,y]=n.useState([]),[A,ie]=n.useState([]),[w,H]=n.useState(""),[ce,O]=n.useState(!1),[p,_]=n.useState({name:""}),[g,L]=n.useState(null),[Se,T]=n.useState(!1),[ee,B]=n.useState(null),[Ce,de]=n.useState([]),[v,U]=n.useState(null),k=n.useRef(null),[f,K]=n.useState(1),[F,Z]=n.useState(0),[D,W]=n.useState(0),[J,$]=n.useState(!1),[ue,me]=n.useState(!1),j=n.useRef(null),X=n.useRef(null),R=n.useRef(null),Q=n.useRef(!1),Pe=n.useRef(null),u=n.useRef(null),m=n.useRef(null),h=n.useMemo(()=>z.find(e=>e.id===d)||null,[z,d]),te=n.useMemo(()=>h?h.location_id?A.filter(e=>e.location_id===h.location_id):A.filter(e=>!e.location_id):[],[A,h]);n.useEffect(()=>{w&&typeof w=="number"&&(te.some(s=>s.id===w)||H(""))},[te,w]),n.useEffect(()=>{const e=S?.id?String(S.id):null,s=e==="all"?"/api/locations":e?`/api/locations?branch_id=${e}`:"/api/locations";fetch(s,{credentials:"same-origin",headers:{Accept:"application/json"}}).then(a=>a.ok?a.json():[]).then(de).catch(()=>de([]))},[S?.id]),n.useEffect(()=>{const e=new URLSearchParams,s=S?.id?String(S.id):null;s&&s!=="all"&&e.set("branch_id",s),N&&e.set("location_id",String(N));const a=e.toString()?`/api/floors?${e.toString()}`:"/api/floors";console.log("Fetching floors from:",a),fetch(a).then(l=>l.json()).then(l=>{console.log("Floors loaded:",l.length,l),E(l),Y&&l.some(i=>i.id===Y)?P(Y):l.length>0?P(l[0].id):P(null)}).catch(l=>{console.error("Error loading floors:",l),E([])});const r=new URLSearchParams;r.set("per_page","1000"),s&&s!=="all"&&r.set("branch_id",s);const o=r.toString()?`/api/devices?${r.toString()}`:"/api/devices?per_page=1000";fetch(o).then(l=>l.json()).then(l=>{const i=l?.data||[];ie(i),I&&i.some(c=>c.id===I)&&H(I)}).catch(()=>ie([]))},[S?.id,N,Y,I]),n.useEffect(()=>{d&&fetch(`/api/device-positions?floor_id=${d}`).then(e=>e.json()).then(y).catch(()=>y([]))},[d]),n.useEffect(()=>()=>{m.current!==null&&(cancelAnimationFrame(m.current),m.current=null)},[]);const he=async e=>{try{const s=await fetch("/api/device-positions/upsert",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"same-origin",body:JSON.stringify(e)});if(!s.ok){const r=await s.text().catch(()=>"");console.error("Save position failed:",s.status,r),alert(`Failed to save position (${s.status}).`);return}const a=await s.json();y(r=>{const o=r.findIndex(l=>l.device_id===a.device_id&&l.floor_id===a.floor_id);if(o>=0){const l=r.slice();return l[o]=a,l}return[...r,a]}),d&&fetch(`/api/device-positions?floor_id=${d}`).then(r=>r.json()).then(y).catch(()=>y([]))}catch(s){console.error("Save position error:",s),alert("Network error while saving position")}},Me=async()=>{if(p.name.trim()){O(!0);try{const e=S?.id?String(S.id):null,s=await fetch("/api/floors",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({branch_id:e&&e!=="all"?typeof e=="string"?parseInt(e):e:null,location_id:N||null,name:p.name.trim(),level:p.level??null,plan_image_path:p.plan_image_path||null})});if(s.ok){const a=await s.json();E(r=>[...r,a].sort((o,l)=>(o.level??0)-(l.level??0))),P(a.id),_({name:""}),T(!1)}else{const a=await s.json().catch(()=>({message:"Failed to create floor"}));alert(a.message||"Failed to create floor")}}catch(e){console.error("Error creating floor:",e),alert("Network error while creating floor")}finally{O(!1)}}},Fe=async()=>{if(!(!g||!p.name.trim())){O(!0);try{const e=await fetch(`/api/floors/${g.id}`,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({branch_id:g.branch_id,location_id:g.location_id,name:p.name.trim(),level:p.level??null,plan_image_path:p.plan_image_path||null})});if(e.ok){const s=await e.json();E(a=>a.map(r=>r.id===s.id?s:r).sort((r,o)=>(r.level??0)-(o.level??0))),L(null),_({name:""}),T(!1),d===s.id&&(P(null),setTimeout(()=>P(s.id),0))}else{const s=await e.json().catch(()=>({message:"Failed to update floor"})),a=s.message||s.error||"Failed to update floor";alert(a)}}catch(e){console.error("Error updating floor:",e),alert("Network error while updating floor")}finally{O(!1)}}},De=async e=>{try{const s=await fetch(`/api/floors/${e}`,{method:"DELETE",headers:{Accept:"application/json"},credentials:"same-origin"});if(s.ok||s.status===204)E(a=>a.filter(r=>r.id!==e)),d===e&&P(null),B(null);else{const a=await s.text().catch(()=>"Failed to delete floor");alert(`Failed to delete floor: ${a}`)}}catch(s){console.error("Error deleting floor:",s),alert("Network error while deleting floor")}},xe=e=>{L({...e}),_({name:e.name,level:e.level??null,plan_image_path:e.plan_image_path??""}),T(!0)},pe=()=>{L(null),_({name:"",level:null,plan_image_path:""}),T(!0)},se=()=>{T(!1),L(null),_({name:""})},ze=async e=>{if(!x||!d||!w||typeof w!="number")return;const s=e.target;if(s.tagName==="BUTTON"||s.closest("button")||s.closest("[data-device-marker]")||!u.current)return;e.preventDefault(),e.stopPropagation();const a=u.current.getBoundingClientRect(),r=f,o=a.width*(1-r)/2-F,l=a.height*(1-r)/2-D;let i=(e.clientX-a.left-o)/(a.width*r),c=(e.clientY-a.top-l)/(a.height*r);i=Math.min(1,Math.max(0,i)),c=Math.min(1,Math.max(0,c)),await he({floor_id:d,device_id:w,x:i,y:c})},Re=e=>({left:`${e.x*100}%`,top:`${e.y*100}%`,transform:"translate(-50%, -100%)"}),V=e=>A.find(s=>s.id===e)?.name||`#${e}`,q=(e,s,a)=>{if(!u.current)return;const r=u.current.getBoundingClientRect(),o=e-r.left,l=s-r.top,i=(o-F-r.width*(1-f)/2)/f,c=(l-D-r.height*(1-f)/2)/f,b=o-i*a-r.width*(1-a)/2,ke=l-c*a-r.height*(1-a)/2;K(a),Z(b),W(ke)},ge=e=>{if(e&&u.current){const s=u.current.getBoundingClientRect(),a=s.left+s.width/2,r=s.top+s.height/2;q(a,r,Math.min(f+.25,5))}else K(s=>Math.min(s+.25,5))},fe=e=>{if(e&&u.current){const s=u.current.getBoundingClientRect(),a=s.left+s.width/2,r=s.top+s.height/2;q(a,r,Math.max(f-.25,.1))}else K(s=>Math.max(s-.25,.1))},be=()=>{K(1),Z(0),W(0)},Ee=e=>{const s=e.target;if(!(s.closest("button")||s.closest("[data-device-marker]"))&&(e.ctrlKey||e.metaKey)){e.preventDefault(),e.stopPropagation();const a=e.deltaY>0?-.1:.1,r=Math.min(Math.max(f+a,.1),5);q(e.clientX,e.clientY,r)}},Le=e=>{const s=e.target;s.closest("[data-device-marker]")||s.tagName==="BUTTON"||s.closest("button")||v||(e.button===1||e.button===2||e.button===0&&ue)&&(e.preventDefault(),e.stopPropagation(),$(!0),j.current={x:e.clientX-F,y:e.clientY-D})},ve=()=>{$(!1),j.current=null},Te=e=>{const s=e.target;if(!(s.closest("[data-device-marker]")||s.tagName==="BUTTON"||s.closest("button"))&&!v){if(e.touches.length===2){e.preventDefault(),e.stopPropagation(),Q.current=!0;const a=e.touches[0],r=e.touches[1],o=Math.hypot(r.clientX-a.clientX,r.clientY-a.clientY);X.current=o,R.current={x:(a.clientX+r.clientX)/2,y:(a.clientY+r.clientY)/2}}else if(e.touches.length===1){e.preventDefault(),e.stopPropagation();const a=e.touches[0];$(!0),j.current={x:a.clientX-F,y:a.clientY-D}}}},Ue=e=>{if(e.touches.length===2&&Q.current&&X.current&&R.current){e.preventDefault(),e.stopPropagation();const s=e.touches[0],a=e.touches[1],r=Math.hypot(a.clientX-s.clientX,a.clientY-s.clientY),o=r/X.current,l=Math.min(Math.max(f*o,.1),5);q(R.current.x,R.current.y,l),X.current=r,R.current={x:(s.clientX+a.clientX)/2,y:(s.clientY+a.clientY)/2}}else if(J&&j.current&&e.touches.length===1){e.preventDefault(),e.stopPropagation();const s=e.touches[0];Z(s.clientX-j.current.x),W(s.clientY-j.current.y)}},$e=()=>{$(!1),j.current=null,Q.current=!1,X.current=null,R.current=null};return n.useEffect(()=>{const e=a=>{a.key===" "&&(a.preventDefault(),me(!0)),(a.ctrlKey||a.metaKey)&&a.key==="="&&(a.preventDefault(),ge()),(a.ctrlKey||a.metaKey)&&a.key==="-"&&(a.preventDefault(),fe()),(a.ctrlKey||a.metaKey)&&a.key==="0"&&(a.preventDefault(),be())},s=a=>{a.key===" "&&(me(!1),$(!1),j.current=null)};return window.addEventListener("keydown",e),window.addEventListener("keyup",s),()=>{window.removeEventListener("keydown",e),window.removeEventListener("keyup",s)}},[]),t.jsxs(Ie,{title:"Floor Plan",children:[t.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[t.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("button",{onClick:()=>{N?je.visit(`/monitor/maps?location_id=${N}`):je.visit("/monitor/maps")},className:"inline-flex items-center justify-center gap-2 rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-medium text-slate-700 transition-all hover:bg-slate-50 hover:shadow-sm dark:border-slate-600 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600",title:"Go back to maps",children:[t.jsx(Je,{className:"size-4"}),t.jsx("span",{className:"hidden sm:inline",children:"Back"})]}),t.jsxs("div",{children:[t.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-slate-900 dark:text-white",children:"Floor Plan Management"}),t.jsx("p",{className:"mt-1 text-sm text-slate-600 dark:text-slate-400",children:x?"Manage floor plans and device positions":"View floor plans and device locations"})]})]}),x&&t.jsxs("button",{onClick:pe,className:"inline-flex items-center gap-2 rounded-lg bg-gradient-to-r from-blue-600 to-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-lg transition-all hover:from-blue-700 hover:to-indigo-700 hover:shadow-xl",children:[t.jsx(Ne,{className:"size-4"}),t.jsx("span",{children:"New Floor"})]})]}),t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-4",children:[t.jsx("div",{className:"lg:col-span-1",children:t.jsxs("div",{className:"rounded-xl border border-slate-200 bg-white shadow-lg dark:border-slate-700 dark:bg-slate-800",children:[t.jsx("div",{className:"border-b border-slate-200 p-4 dark:border-slate-700",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(we,{className:"size-5 text-blue-600 dark:text-blue-400"}),t.jsx("h2",{className:"text-lg font-semibold text-slate-900 dark:text-white",children:"Floors"}),t.jsx("span",{className:"ml-auto rounded-full bg-slate-100 px-2.5 py-0.5 text-xs font-semibold text-slate-600 dark:bg-slate-700 dark:text-slate-400",children:z.length})]})}),t.jsx("div",{className:"max-h-[400px] overflow-y-auto p-2",children:z.length===0?t.jsxs("div",{className:"p-8 text-center",children:[t.jsx(we,{className:"mx-auto mb-3 size-10 text-slate-400"}),t.jsx("p",{className:"text-sm text-slate-600 dark:text-slate-400",children:"No floors found"}),x&&t.jsx("button",{onClick:pe,className:"mt-3 text-sm text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300",children:"Create your first floor"})]}):t.jsx("div",{className:"space-y-2",children:z.map(e=>t.jsx("div",{className:`group relative rounded-lg border-2 p-3 transition-all cursor-pointer ${d===e.id?"border-blue-500 bg-blue-50 dark:bg-blue-950/20 shadow-md":"border-slate-200 bg-slate-50 hover:border-slate-300 hover:bg-slate-100 dark:border-slate-700 dark:bg-slate-900/50 dark:hover:bg-slate-800"}`,onClick:()=>P(e.id),children:t.jsxs("div",{className:"flex items-start justify-between gap-2",children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[e.level!==null&&t.jsxs("span",{className:"flex-shrink-0 rounded bg-blue-100 px-1.5 py-0.5 text-xs font-bold text-blue-700 dark:bg-blue-900/50 dark:text-blue-300",children:["L",e.level]}),t.jsx("h3",{className:"truncate font-semibold text-slate-900 dark:text-white",children:e.name})]}),e.plan_image_path&&t.jsxs("div",{className:"mt-1 flex items-center gap-1 text-xs text-slate-500 dark:text-slate-400",children:[t.jsx(oe,{className:"size-3"}),t.jsx("span",{className:"truncate",children:"Plan image set"})]}),M.filter(s=>s.floor_id===e.id).length>0&&t.jsxs("div",{className:"mt-1 text-xs text-slate-500 dark:text-slate-400",children:[M.filter(s=>s.floor_id===e.id).length," device",M.filter(s=>s.floor_id===e.id).length!==1?"s":""]})]}),x&&t.jsxs("div",{className:"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[t.jsx("button",{onClick:s=>{s.stopPropagation(),xe(e)},className:"rounded p-1.5 text-blue-600 hover:bg-blue-100 dark:text-blue-400 dark:hover:bg-blue-900/50",title:"Edit floor",children:t.jsx(le,{className:"size-4"})}),t.jsx("button",{onClick:s=>{s.stopPropagation(),B(e.id)},className:"rounded p-1.5 text-red-600 hover:bg-red-100 dark:text-red-400 dark:hover:bg-red-900/50",title:"Delete floor",children:t.jsx(ne,{className:"size-4"})})]})]})},e.id))})})]})}),t.jsxs("div",{className:"lg:col-span-3 space-y-4",children:[x&&d&&t.jsx("div",{className:"rounded-xl border border-slate-200 bg-gradient-to-r from-slate-50 to-slate-100 p-4 dark:border-slate-700 dark:from-slate-900/50 dark:to-slate-800/50",children:t.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(_e,{className:"size-5 text-blue-600 dark:text-blue-400"}),t.jsx("span",{className:"text-sm font-semibold text-slate-700 dark:text-slate-300",children:"Place Device on Floor"})]}),t.jsxs("select",{className:"flex-1 w-full sm:w-auto rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-700 dark:text-white",value:w||"",onChange:e=>H(e.target.value?Number(e.target.value):""),children:[t.jsx("option",{value:"",children:"â€” Select Device â€”"}),te.map(e=>t.jsxs("option",{value:e.id,children:[e.name," (",e.ip_address,")"]},e.id))]}),w&&t.jsx("p",{className:"text-xs text-slate-600 dark:text-slate-400",children:"Click on the plan to place this device"})]})}),t.jsx("div",{className:"relative",children:t.jsxs("div",{ref:u,onClick:ze,onMouseDown:Le,onTouchStart:Te,onTouchMove:Ue,onTouchEnd:$e,onWheel:Ee,onContextMenu:e=>{e.preventDefault(),e.stopPropagation()},onMouseMove:e=>{if(J&&j.current){e.preventDefault(),e.stopPropagation(),Z(e.clientX-j.current.x),W(e.clientY-j.current.y);return}x&&(!v||!d||!u.current||(e.preventDefault(),e.stopPropagation(),m.current!==null&&cancelAnimationFrame(m.current),m.current=requestAnimationFrame(()=>{if(!u.current)return;const s=u.current.getBoundingClientRect(),a=f,r=s.width*(1-a)/2-F,o=s.height*(1-a)/2-D;let l=(e.clientX-s.left-r)/(s.width*a),i=(e.clientY-s.top-o)/(s.height*a);k.current&&(l-=k.current.x,i-=k.current.y),l=Math.min(1,Math.max(0,l)),i=Math.min(1,Math.max(0,i)),y(c=>c.map(b=>b.device_id===v?{...b,x:l,y:i}:b)),m.current=null})))},onMouseUp:async e=>{if(ve(),!x||!v||!d||!u.current)return;const s=e.target;if(s.tagName==="BUTTON"||s.closest("button")){U(null),k.current=null,m.current!==null&&(cancelAnimationFrame(m.current),m.current=null);return}e.preventDefault(),e.stopPropagation(),m.current!==null&&(cancelAnimationFrame(m.current),m.current=null);const a=u.current.getBoundingClientRect(),r=f,o=a.width*(1-r)/2-F,l=a.height*(1-r)/2-D;let i=(e.clientX-a.left-o)/(a.width*r),c=(e.clientY-a.top-l)/(a.height*r);k.current&&(i-=k.current.x,c-=k.current.y),i=Math.min(1,Math.max(0,i)),c=Math.min(1,Math.max(0,c));const b=M.find(ae=>ae.device_id===v);if(!window.confirm(`Move ${b?V(b.device_id):"device"} to (${(i*100).toFixed(1)}%, ${(c*100).toFixed(1)}%)?`)){b&&y(ae=>ae.map(re=>re.device_id===b.device_id?{...re,x:b.x,y:b.y}:re)),U(null),k.current=null;return}const Xe={floor_id:d,device_id:v,x:i,y:c,marker_type:void 0};U(null),k.current=null,await he(Xe)},onMouseLeave:e=>{if(ve(),v&&x){m.current!==null&&(cancelAnimationFrame(m.current),m.current=null);const s=M.find(a=>a.device_id===v);s&&y(a=>a.map(r=>r.device_id===s.device_id?{...r,x:s.x,y:s.y}:r)),U(null),k.current=null}},className:"relative w-full overflow-hidden rounded-xl border border-slate-200 bg-slate-50 dark:border-slate-700 dark:bg-slate-900 touch-pan-y touch-pan-x",style:{aspectRatio:"16 / 10",minHeight:"300px",userSelect:"none",WebkitUserSelect:"none",WebkitTouchCallout:"none",touchAction:"pan-x pan-y",cursor:J?"grabbing":ue?"grab":v?"grabbing":"default"},children:[t.jsxs("div",{className:"absolute right-2 sm:right-4 top-2 sm:top-4 z-20 flex flex-col gap-1.5 rounded-lg bg-white/95 backdrop-blur-sm border border-slate-200/50 p-2 shadow-xl dark:bg-slate-800/95 dark:border-slate-700/50",onClick:e=>e.stopPropagation(),children:[t.jsx("button",{onClick:e=>{e.stopPropagation(),ge(e)},className:"flex items-center justify-center rounded-md border border-slate-300 bg-white p-2 hover:bg-blue-50 hover:border-blue-300 active:scale-95 transition-all dark:border-slate-600 dark:bg-slate-700 dark:hover:bg-blue-900/30 dark:hover:border-blue-600 touch-manipulation",title:"Zoom In (Ctrl/Cmd + Plus)",children:t.jsx(qe,{className:"size-4 text-slate-700 dark:text-slate-300"})}),t.jsx("button",{onClick:e=>{e.stopPropagation(),fe(e)},className:"flex items-center justify-center rounded-md border border-slate-300 bg-white p-2 hover:bg-blue-50 hover:border-blue-300 active:scale-95 transition-all dark:border-slate-600 dark:bg-slate-700 dark:hover:bg-blue-900/30 dark:hover:border-blue-600 touch-manipulation",title:"Zoom Out (Ctrl/Cmd + Minus)",children:t.jsx(He,{className:"size-4 text-slate-700 dark:text-slate-300"})}),t.jsxs("div",{className:"px-2 py-1 text-center text-xs font-semibold text-slate-600 dark:text-slate-400 border-t border-slate-200 dark:border-slate-700",children:[Math.round(f*100),"%"]}),t.jsx("button",{onClick:e=>{e.stopPropagation(),be()},className:"flex items-center justify-center rounded-md border border-slate-300 bg-white p-2 hover:bg-slate-50 active:scale-95 transition-all dark:border-slate-600 dark:bg-slate-700 dark:hover:bg-slate-600 touch-manipulation",title:"Reset Zoom (Ctrl/Cmd + 0)",children:t.jsx(Be,{className:"size-4 text-slate-700 dark:text-slate-300"})})]}),t.jsxs("div",{style:{transform:`translate(${F}px, ${D}px) scale(${f})`,transformOrigin:"top left",width:"100%",height:"100%",transition:J||Q.current?"none":"transform 0.1s ease-out"},children:[h?.plan_image_path?t.jsx("img",{ref:Pe,src:h.plan_image_path,className:"h-full w-full object-contain select-none",style:{userSelect:"none",WebkitUserSelect:"none",pointerEvents:"none"},alt:h.name,draggable:!1}):t.jsxs("div",{className:"absolute inset-0 flex items-center justify-center text-slate-500 dark:text-slate-400",children:[t.jsx(ye,{className:"mr-2 size-5"})," Select a floor with a plan image"]}),h&&M.map(e=>t.jsx("div",{"data-device-marker":!0,className:`absolute ${x?"cursor-move group":"cursor-default"}`,style:{...Re(e),userSelect:"none",WebkitUserSelect:"none",pointerEvents:"auto"},title:`${V(e.device_id)} @ (${(e.x*100).toFixed(1)}%, ${(e.y*100).toFixed(1)}%)`,onMouseDown:s=>{if(s.preventDefault(),s.stopPropagation(),x&&u.current){const a=u.current.getBoundingClientRect();s.currentTarget.getBoundingClientRect();const o=s.clientX-a.left,l=s.clientY-a.top,i=e.x*a.width,c=e.y*a.height;k.current={x:(o-i)/a.width,y:(l-c)/a.height},U(e.device_id)}},draggable:!1,children:t.jsxs("div",{className:"relative flex -translate-y-1/2 flex-col items-center select-none",style:{userSelect:"none",WebkitUserSelect:"none"},children:[t.jsx("div",{className:"rounded bg-white/90 px-2 py-0.5 text-[10px] font-medium shadow dark:bg-slate-800/90 select-none",style:{userSelect:"none",WebkitUserSelect:"none"},children:V(e.device_id)}),t.jsx("div",{className:`mt-1 rounded-full p-1.5 shadow ring-2 ring-white/60 dark:ring-slate-900/60 select-none relative animate-pulse ${e.device?.status==="online"?"bg-green-600 text-white":e.device?.status==="warning"?"bg-yellow-500 text-white":"bg-red-600 text-white"}`,style:{userSelect:"none",WebkitUserSelect:"none",boxShadow:e.device?.status==="online"?"0 0 15px rgba(34, 197, 94, 0.8), 0 0 30px rgba(34, 197, 94, 0.5), 0 0 45px rgba(34, 197, 94, 0.3)":e.device?.status==="warning"?"0 0 15px rgba(234, 179, 8, 0.8), 0 0 30px rgba(234, 179, 8, 0.5), 0 0 45px rgba(234, 179, 8, 0.3)":"0 0 15px rgba(220, 38, 38, 0.8), 0 0 30px rgba(220, 38, 38, 0.5), 0 0 45px rgba(220, 38, 38, 0.3)"},children:(()=>{const s=Oe(e.device?.category||"");return t.jsx(s,{className:"size-5"})})()}),x&&v!==e.device_id&&t.jsx("button",{onClick:async s=>{if(s.preventDefault(),s.stopPropagation(),!confirm(`Remove ${V(e.device_id)} from this floor?`))return;const a=await fetch(`/api/device-positions/${e.id}`,{method:"DELETE",headers:{Accept:"application/json"},credentials:"same-origin"});if(a.status===204||a.ok)y(r=>r.filter(o=>o.id!==e.id));else{const r=await a.text().catch(()=>"");alert(`Failed to delete position (${a.status}). ${r}`)}},onMouseDown:s=>{s.preventDefault(),s.stopPropagation()},className:"absolute -bottom-6 left-1/2 -translate-x-1/2 hidden rounded bg-red-600 px-1.5 py-0.5 text-[10px] font-semibold text-white shadow hover:bg-red-700 group-hover:block z-10",title:"Delete pin",children:"Delete"})]})},e.device_id))]})]})}),h&&t.jsx("div",{className:"rounded-xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("h3",{className:"text-lg font-semibold text-slate-900 dark:text-white",children:h.name}),t.jsxs("div",{className:"mt-1 flex flex-wrap items-center gap-3 text-sm text-slate-600 dark:text-slate-400",children:[h.level!==null&&t.jsxs("span",{className:"flex items-center gap-1",children:[t.jsx(Ae,{className:"size-4"}),"Level ",h.level]}),t.jsxs("span",{className:"flex items-center gap-1",children:[t.jsx(_e,{className:"size-4"}),M.filter(e=>e.floor_id===h.id).length," device",M.filter(e=>e.floor_id===h.id).length!==1?"s":""]}),h.plan_image_path&&t.jsxs("span",{className:"flex items-center gap-1 text-green-600 dark:text-green-400",children:[t.jsx(oe,{className:"size-4"}),"Plan image loaded"]})]})]}),x&&t.jsx("div",{className:"flex items-center gap-2",children:t.jsxs("button",{onClick:()=>xe(h),className:"inline-flex items-center gap-2 rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-medium text-slate-700 transition-all hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600",children:[t.jsx(le,{className:"size-4"}),t.jsx("span",{className:"hidden sm:inline",children:"Edit"})]})})]})})]})]}),t.jsx("div",{className:"rounded-lg border border-slate-200 bg-slate-50 p-3 dark:border-slate-700 dark:bg-slate-800/50",children:t.jsx("p",{className:"text-xs text-slate-600 dark:text-slate-400",children:x?t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"hidden sm:inline",children:"ðŸ’¡ Tip: Zoom with mouse wheel (Ctrl/Cmd + scroll), zoom slider, or buttons. Pan with middle/right mouse button or Space + drag. Pinch to zoom on touch devices. Keyboard: Ctrl/Cmd + Plus/Minus/0. Select a device and click on the plan to place it."}),t.jsx("span",{className:"sm:hidden",children:"ðŸ’¡ Tip: Use zoom buttons or slider to zoom. Pinch to zoom or touch and drag to pan. Select a device and tap on the plan to place it."})]}):t.jsxs(t.Fragment,{children:[t.jsxs("span",{className:"hidden sm:inline",children:["View-only mode. Zoom with mouse wheel (Ctrl/Cmd + scroll), zoom slider, or buttons. Pan with middle/right mouse button or Space + drag. Pinch to zoom on touch devices. Keyboard: Ctrl/Cmd + Plus/Minus/0. Add ",t.jsx("code",{className:"rounded bg-slate-200 px-1 py-0.5 text-[10px] dark:bg-slate-700",children:"?mode=config"})," to the URL to enable editing."]}),t.jsx("span",{className:"sm:hidden",children:"View-only mode. Pinch to zoom or touch and drag to pan. Add ?mode=config to enable editing."})]})})})]}),Se&&t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4",onClick:se,children:t.jsxs("div",{className:"w-full max-w-2xl rounded-2xl border border-slate-200 bg-white shadow-2xl dark:border-slate-700 dark:bg-slate-800",onClick:e=>e.stopPropagation(),children:[t.jsx("div",{className:"border-b border-slate-200 p-6 dark:border-slate-700",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 p-2",children:g?t.jsx(le,{className:"size-5 text-white"}):t.jsx(Ne,{className:"size-5 text-white"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-xl font-bold text-slate-900 dark:text-white",children:g?"Edit Floor":"Create New Floor"}),t.jsx("p",{className:"text-sm text-slate-600 dark:text-slate-400",children:g?"Update floor details and plan image":"Add a new floor plan to the system"})]})]}),t.jsx("button",{onClick:se,className:"rounded-lg p-2 text-slate-500 transition-all hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-700",children:t.jsx(Ke,{className:"size-5"})})]})}),t.jsxs("div",{className:"p-6 space-y-4",children:[t.jsxs("div",{children:[t.jsxs("label",{className:"mb-2 block text-sm font-medium text-slate-700 dark:text-slate-300",children:["Floor Name ",t.jsx("span",{className:"text-red-500",children:"*"})]}),t.jsx("input",{type:"text",placeholder:"e.g., Block A - Level 2, Main Building - Ground Floor",className:"w-full rounded-lg border border-slate-300 bg-white px-4 py-2.5 text-slate-900 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white",value:p.name,onChange:e=>_(s=>({...s,name:e.target.value}))})]}),t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"mb-2 block text-sm font-medium text-slate-700 dark:text-slate-300",children:"Level (Optional)"}),t.jsx("input",{type:"number",placeholder:"e.g., 0, 1, 2, -1",className:"w-full rounded-lg border border-slate-300 bg-white px-4 py-2.5 text-slate-900 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white",value:p.level??"",onChange:e=>_(s=>({...s,level:e.target.value?Number(e.target.value):null}))})]}),t.jsxs("div",{children:[t.jsx("label",{className:"mb-2 block text-sm font-medium text-slate-700 dark:text-slate-300",children:"Location (Optional)"}),t.jsxs("select",{className:"w-full rounded-lg border border-slate-300 bg-white px-4 py-2.5 text-slate-900 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white",value:g?.location_id??N??"",onChange:e=>{if(g){const s=e.target.value?Number(e.target.value):null;L(a=>a?{...a,location_id:s}:null)}},disabled:!g&&!!N,children:[t.jsx("option",{value:"",children:"No location"}),Ce.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]}),!g&&N&&t.jsx("p",{className:"mt-1 text-xs text-slate-500 dark:text-slate-400",children:"Location is set from URL parameter"})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"mb-2 block text-sm font-medium text-slate-700 dark:text-slate-300",children:"Plan Image Path or URL"}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("input",{type:"text",placeholder:"/storage/floor-plans/image.png or https://example.com/plan.jpg",className:"flex-1 rounded-lg border border-slate-300 bg-white px-4 py-2.5 text-sm text-slate-900 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white",value:p.plan_image_path??"",onChange:e=>_(s=>({...s,plan_image_path:e.target.value}))}),t.jsxs("label",{className:"inline-flex cursor-pointer items-center gap-2 rounded-lg border border-slate-300 bg-white px-4 py-2.5 text-sm font-medium text-slate-700 transition-all hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600",children:[t.jsx(ye,{className:"size-4"}),t.jsx("span",{className:"hidden sm:inline",children:"Upload"}),t.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:async e=>{const s=e.target.files?.[0];if(!s)return;const a=new FormData;a.append("image",s);const r=await fetch("/api/floor-plans/upload",{method:"POST",body:a});if(r.ok){const o=await r.json();_(l=>({...l,plan_image_path:o.path}))}else alert("Upload failed")}})]})]}),t.jsx("p",{className:"mt-1 text-xs text-slate-500 dark:text-slate-400",children:"Upload an image file or enter a URL/path to the floor plan image"})]}),p.plan_image_path&&t.jsx("div",{className:"rounded-lg border border-slate-200 bg-slate-50 p-3 dark:border-slate-700 dark:bg-slate-900/50",children:t.jsxs("div",{className:"flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400",children:[t.jsx(oe,{className:"size-4"}),t.jsx("span",{className:"truncate",children:p.plan_image_path})]})})]}),t.jsx("div",{className:"border-t border-slate-200 p-6 dark:border-slate-700",children:t.jsxs("div",{className:"flex items-center justify-end gap-3",children:[t.jsx("button",{onClick:se,className:"rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 transition-all hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600",children:"Cancel"}),t.jsxs("button",{onClick:g?Fe:Me,disabled:ce||!p.name.trim(),className:"inline-flex items-center gap-2 rounded-lg bg-gradient-to-r from-blue-600 to-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-lg transition-all hover:from-blue-700 hover:to-indigo-700 hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed",children:[t.jsx(Ze,{className:"size-4"}),ce?"Saving...":g?"Update Floor":"Create Floor"]})]})})]})}),ee&&t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4",onClick:()=>B(null),children:t.jsxs("div",{className:"w-full max-w-md rounded-2xl border border-red-200 bg-white shadow-2xl dark:border-red-900/50 dark:bg-slate-800",onClick:e=>e.stopPropagation(),children:[t.jsx("div",{className:"border-b border-red-200 p-6 dark:border-red-900/50",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"rounded-full bg-red-100 p-3 dark:bg-red-900/30",children:t.jsx(ne,{className:"size-6 text-red-600 dark:text-red-400"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-xl font-bold text-slate-900 dark:text-white",children:"Delete Floor"}),t.jsx("p",{className:"text-sm text-slate-600 dark:text-slate-400",children:"This action cannot be undone"})]})]})}),t.jsxs("div",{className:"p-6",children:[t.jsxs("p",{className:"text-slate-700 dark:text-slate-300",children:["Are you sure you want to delete ",t.jsx("strong",{children:z.find(e=>e.id===ee)?.name}),"?"]}),t.jsx("p",{className:"mt-2 text-sm text-slate-600 dark:text-slate-400",children:"This will also delete all device positions on this floor."})]}),t.jsx("div",{className:"border-t border-red-200 p-6 dark:border-red-900/50",children:t.jsxs("div",{className:"flex items-center justify-end gap-3",children:[t.jsx("button",{onClick:()=>B(null),className:"rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 transition-all hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600",children:"Cancel"}),t.jsxs("button",{onClick:()=>De(ee),className:"inline-flex items-center gap-2 rounded-lg bg-red-600 px-4 py-2 text-sm font-medium text-white shadow-lg transition-all hover:bg-red-700 hover:shadow-xl",children:[t.jsx(ne,{className:"size-4"}),"Delete Floor"]})]})})]})})]})}export{ht as default};
